(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class W{constructor(e){this.game=e,this.canvas=null,this.ctx=null,this.nextCanvas=null,this.nextCtx=null,this.holdCanvas=null,this.holdCtx=null,this.cellSize=30,this.animationFrame=0,this.lineClearAnimation=null,this.particles=[]}initialize(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.nextCanvas=document.getElementById("nextCanvas"),this.nextCtx=this.nextCanvas.getContext("2d"),this.holdCanvas=document.getElementById("holdCanvas"),this.holdCtx=this.holdCanvas.getContext("2d"),[this.ctx,this.nextCtx,this.holdCtx].forEach(e=>{e.imageSmoothingEnabled=!1}),this.initParticles()}initParticles(){for(let e=0;e<20;e++)this.particles.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,vx:(Math.random()-.5)*.5,vy:Math.random()*.5+.5,size:Math.random()*2+1,opacity:Math.random()*.5+.1})}render(){this.clearCanvas(),this.drawGrid(),this.drawBoard(),this.drawGhostPiece(),this.drawCurrentPiece(),this.drawParticles(),this.renderNext(),this.renderHold(),this.animationFrame++,this.lineClearAnimation&&this.drawLineClearAnimation()}clearCanvas(){const e=this.ctx.createLinearGradient(0,0,0,this.canvas.height);e.addColorStop(0,"#0a0a0a"),e.addColorStop(1,"#1a0a2a"),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawGrid(){this.ctx.strokeStyle="rgba(255, 255, 255, 0.05)",this.ctx.lineWidth=1;for(let e=0;e<=10;e++)this.ctx.beginPath(),this.ctx.moveTo(e*this.cellSize,0),this.ctx.lineTo(e*this.cellSize,this.canvas.height),this.ctx.stroke();for(let e=0;e<=20;e++)this.ctx.beginPath(),this.ctx.moveTo(0,e*this.cellSize),this.ctx.lineTo(this.canvas.width,e*this.cellSize),this.ctx.stroke()}drawBoard(){const e=this.game.board;for(let t=0;t<e.length;t++)for(let s=0;s<e[t].length;s++)e[t][s]&&this.drawCell(s,t,e[t][s],1)}drawCurrentPiece(){const e=this.game.currentPiece;if(!e)return;const t=e.shape;for(let s=0;s<t.length;s++)for(let i=0;i<t[s].length;i++)t[s][i]&&this.drawCell(e.x+i,e.y+s,e.color,1)}drawGhostPiece(){const e=this.game.getGhostPosition();if(!e)return;const t=e.shape;for(let s=0;s<t.length;s++)for(let i=0;i<t[s].length;i++)t[s][i]&&this.drawCell(e.x+i,e.y+s,e.color,.2)}drawCell(e,t,s,i=1){const r=e*this.cellSize,n=t*this.cellSize,o=this.cellSize,c=1,u=this.ctx.createLinearGradient(r,n,r+o,n+o),f=this.hexToRgb(s);u.addColorStop(0,`rgba(${f.r}, ${f.g}, ${f.b}, ${i})`),u.addColorStop(1,`rgba(${f.r*.6}, ${f.g*.6}, ${f.b*.6}, ${i})`),this.ctx.fillStyle=u,this.ctx.fillRect(r+c,n+c,o-c*2,o-c*2),i>.5&&(this.ctx.shadowColor=s,this.ctx.shadowBlur=10,this.ctx.strokeStyle=s,this.ctx.lineWidth=1,this.ctx.strokeRect(r+c,n+c,o-c*2,o-c*2),this.ctx.shadowBlur=0),this.ctx.strokeStyle=`rgba(255, 255, 255, ${i*.3})`,this.ctx.lineWidth=1,this.ctx.strokeRect(r+c+2,n+c+2,o-c*2-4,o-c*2-4)}renderNext(){const e=this.nextCtx.createLinearGradient(0,0,0,this.nextCanvas.height);e.addColorStop(0,"rgba(10, 10, 10, 0.8)"),e.addColorStop(1,"rgba(26, 10, 42, 0.8)"),this.nextCtx.fillStyle=e,this.nextCtx.fillRect(0,0,this.nextCanvas.width,this.nextCanvas.height);const t=this.game.nextPieces,s={I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:"#00ffff"},O:{shape:[[1,1],[1,1]],color:"#ffff00"},T:{shape:[[0,1,0],[1,1,1],[0,0,0]],color:"#ff00ff"},S:{shape:[[0,1,1],[1,1,0],[0,0,0]],color:"#00ff00"},Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],color:"#ff0000"},J:{shape:[[1,0,0],[1,1,1],[0,0,0]],color:"#0000ff"},L:{shape:[[0,0,1],[1,1,1],[0,0,0]],color:"#ff8800"}};for(let i=0;i<Math.min(3,t.length);i++){const r=s[t[i]];r&&this.drawPiecePreview(this.nextCtx,r.shape,r.color,60,40+i*120,20)}}renderHold(){const e=this.holdCtx.createLinearGradient(0,0,0,this.holdCanvas.height);if(e.addColorStop(0,"rgba(10, 10, 10, 0.8)"),e.addColorStop(1,"rgba(26, 10, 42, 0.8)"),this.holdCtx.fillStyle=e,this.holdCtx.fillRect(0,0,this.holdCanvas.width,this.holdCanvas.height),this.game.holdPiece){const s={I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:"#00ffff"},O:{shape:[[1,1],[1,1]],color:"#ffff00"},T:{shape:[[0,1,0],[1,1,1],[0,0,0]],color:"#ff00ff"},S:{shape:[[0,1,1],[1,1,0],[0,0,0]],color:"#00ff00"},Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],color:"#ff0000"},J:{shape:[[1,0,0],[1,1,1],[0,0,0]],color:"#0000ff"},L:{shape:[[0,0,1],[1,1,1],[0,0,0]],color:"#ff8800"}}[this.game.holdPiece];if(s){const i=this.game.canHold?1:.3;this.drawPiecePreview(this.holdCtx,s.shape,s.color,60,60,20,i)}}}drawPiecePreview(e,t,s,i,r,n,o=1){const c=t[0].length,u=t.length,f=i-c*n/2,I=r-u*n/2;for(let S=0;S<u;S++)for(let _=0;_<c;_++)if(t[S][_]){const P=f+_*n,d=I+S*n,x=e.createLinearGradient(P,d,P+n,d+n),y=this.hexToRgb(s);x.addColorStop(0,`rgba(${y.r}, ${y.g}, ${y.b}, ${o})`),x.addColorStop(1,`rgba(${y.r*.6}, ${y.g*.6}, ${y.b*.6}, ${o})`),e.fillStyle=x,e.fillRect(P+1,d+1,n-2,n-2),e.strokeStyle=`rgba(255, 255, 255, ${o*.3})`,e.lineWidth=1,e.strokeRect(P+1,d+1,n-2,n-2)}}drawParticles(){this.ctx.save();for(let e of this.particles)e.x+=e.vx,e.y+=e.vy,e.y>this.canvas.height&&(e.y=-10,e.x=Math.random()*this.canvas.width),e.x<0&&(e.x=this.canvas.width),e.x>this.canvas.width&&(e.x=0),this.ctx.fillStyle=`rgba(255, 255, 255, ${e.opacity})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.fill();this.ctx.restore()}animateLineClear(e){this.lineClearAnimation={lines:e,frame:0,maxFrames:30}}drawLineClearAnimation(){const e=this.lineClearAnimation,t=e.frame/e.maxFrames;if(e.frame<10&&(this.ctx.fillStyle=`rgba(255, 255, 255, ${.3*(1-t*3)})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)),e.frame===0)for(let s=0;s<e.lines*10;s++)this.particles.push({x:Math.random()*this.canvas.width,y:this.canvas.height*.7,vx:(Math.random()-.5)*5,vy:-Math.random()*5-2,size:Math.random()*3+2,opacity:1,lifetime:30});e.frame++,e.frame>=e.maxFrames&&(this.lineClearAnimation=null),this.particles=this.particles.filter(s=>!s.lifetime||--s.lifetime>0)}hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:255,g:255,b:255}}}class z{constructor(e){this.game=e,this.keys={},this.keyTimers={},this.dasTimer=null,this.arrTimer=null,this.touchStartX=null,this.touchStartY=null,this.touchStartTime=null}initialize(){this.setupKeyboardControls(),this.setupTouchControls(),this.setupGamepadControls()}setupKeyboardControls(){document.addEventListener("keydown",e=>this.handleKeyDown(e)),document.addEventListener("keyup",e=>this.handleKeyUp(e))}handleKeyDown(e){if(["ArrowLeft","ArrowRight","ArrowDown","ArrowUp"," ","c","C","Escape"].includes(e.key)&&e.preventDefault(),!this.keys[e.key])switch(this.keys[e.key]=!0,e.key){case"ArrowLeft":this.handleMoveLeft(),this.startDAS("left");break;case"ArrowRight":this.handleMoveRight(),this.startDAS("right");break;case"ArrowDown":this.handleSoftDrop();break;case"ArrowUp":this.handleRotate();break;case"z":case"Z":this.handleRotate(!1);break;case" ":this.handleHardDrop();break;case"c":case"C":this.handleHold();break;case"Escape":this.handlePause();break;case"Enter":this.game.isGameOver&&this.game.startGame();break}}handleKeyUp(e){delete this.keys[e.key],(e.key==="ArrowLeft"||e.key==="ArrowRight")&&this.stopDAS(),e.key==="ArrowDown"&&this.stopSoftDrop()}handleMoveLeft(){!this.game.isPlaying||this.game.isPaused||(this.game.moveLeft(),this.game.playSound("move"))}handleMoveRight(){!this.game.isPlaying||this.game.isPaused||(this.game.moveRight(),this.game.playSound("move"))}handleRotate(e=!0){!this.game.isPlaying||this.game.isPaused||this.game.rotate(e)&&this.game.playSound("rotate")}handleSoftDrop(){!this.game.isPlaying||this.game.isPaused||(this.game.moveDown(),this.keyTimers.softDrop||(this.keyTimers.softDrop=setInterval(()=>{this.keys.ArrowDown&&!this.game.isPaused&&this.game.moveDown()},50)))}stopSoftDrop(){this.keyTimers.softDrop&&(clearInterval(this.keyTimers.softDrop),this.keyTimers.softDrop=null)}handleHardDrop(){!this.game.isPlaying||this.game.isPaused||this.game.hardDrop()}handleHold(){!this.game.isPlaying||this.game.isPaused||(this.game.hold(),this.game.playSound("move"))}handlePause(){this.game.isPlaying&&(this.game.isPaused?this.game.resume():this.game.pause())}startDAS(e){this.stopDAS(),this.dasTimer=setTimeout(()=>{this.arrTimer=setInterval(()=>{this.game.isPaused||(e==="left"&&this.keys.ArrowLeft?this.game.moveLeft():e==="right"&&this.keys.ArrowRight?this.game.moveRight():this.stopDAS())},30)},150)}stopDAS(){this.dasTimer&&(clearTimeout(this.dasTimer),this.dasTimer=null),this.arrTimer&&(clearInterval(this.arrTimer),this.arrTimer=null)}setupTouchControls(){const e=document.getElementById("gameCanvas");e.addEventListener("touchstart",t=>this.handleTouchStart(t),{passive:!1}),e.addEventListener("touchmove",t=>this.handleTouchMove(t),{passive:!1}),e.addEventListener("touchend",t=>this.handleTouchEnd(t),{passive:!1}),this.setupMobileButtons()}handleTouchStart(e){e.preventDefault();const t=e.touches[0];this.touchStartX=t.clientX,this.touchStartY=t.clientY,this.touchStartTime=Date.now()}handleTouchMove(e){if(e.preventDefault(),!this.touchStartX||!this.touchStartY)return;const t=e.touches[0],s=t.clientX-this.touchStartX,i=t.clientY-this.touchStartY,r=25;Math.abs(s)>r&&Math.abs(s)>Math.abs(i)&&(s>0?this.handleMoveRight():this.handleMoveLeft(),this.touchStartX=t.clientX),i>r&&Math.abs(i)>Math.abs(s)&&(this.handleSoftDrop(),this.touchStartY=t.clientY)}handleTouchEnd(e){if(e.preventDefault(),!this.touchStartTime)return;const t=Date.now()-this.touchStartTime,s=e.changedTouches[0],i=Math.abs(s.clientX-this.touchStartX),r=Math.abs(s.clientY-this.touchStartY);t<250&&i<15&&r<15&&this.handleRotate(),t<300&&r>40&&s.clientY-this.touchStartY<-40&&this.handleHardDrop(),this.touchStartX=null,this.touchStartY=null,this.touchStartTime=null,this.stopSoftDrop()}setupGamepadControls(){this.gamepadIndex=null,this.gamepadButtons={},window.addEventListener("gamepadconnected",e=>{console.log("Gamepad connected:",e.gamepad.id),this.gamepadIndex=e.gamepad.index}),window.addEventListener("gamepaddisconnected",e=>{console.log("Gamepad disconnected:",e.gamepad.id),this.gamepadIndex===e.gamepad.index&&(this.gamepadIndex=null)}),this.pollGamepad()}pollGamepad(){var e,t,s,i,r,n,o,c,u,f,I,S,_,P;if(this.gamepadIndex!==null){const d=navigator.getGamepads()[this.gamepadIndex];if(d){const x=((e=d.buttons[14])==null?void 0:e.pressed)||d.axes[0]<-.5,y=((t=d.buttons[15])==null?void 0:t.pressed)||d.axes[0]>.5,H=((s=d.buttons[13])==null?void 0:s.pressed)||d.axes[1]>.5;(i=d.buttons[12])!=null&&i.pressed||d.axes[1]<-.5,x&&!this.gamepadButtons.left?(this.handleMoveLeft(),this.gamepadButtons.left=!0):x||(this.gamepadButtons.left=!1),y&&!this.gamepadButtons.right?(this.handleMoveRight(),this.gamepadButtons.right=!0):y||(this.gamepadButtons.right=!1),H&&!this.gamepadButtons.down?(this.handleSoftDrop(),this.gamepadButtons.down=!0):H||(this.gamepadButtons.down=!1,this.stopSoftDrop()),(r=d.buttons[0])!=null&&r.pressed&&!this.gamepadButtons.a?(this.handleRotate(),this.gamepadButtons.a=!0):(n=d.buttons[0])!=null&&n.pressed||(this.gamepadButtons.a=!1),(o=d.buttons[1])!=null&&o.pressed&&!this.gamepadButtons.b?(this.handleRotate(!1),this.gamepadButtons.b=!0):(c=d.buttons[1])!=null&&c.pressed||(this.gamepadButtons.b=!1),(u=d.buttons[2])!=null&&u.pressed&&!this.gamepadButtons.x?(this.handleHold(),this.gamepadButtons.x=!0):(f=d.buttons[2])!=null&&f.pressed||(this.gamepadButtons.x=!1),(I=d.buttons[3])!=null&&I.pressed&&!this.gamepadButtons.y?(this.handleHardDrop(),this.gamepadButtons.y=!0):(S=d.buttons[3])!=null&&S.pressed||(this.gamepadButtons.y=!1),(_=d.buttons[9])!=null&&_.pressed&&!this.gamepadButtons.start?(this.handlePause(),this.gamepadButtons.start=!0):(P=d.buttons[9])!=null&&P.pressed||(this.gamepadButtons.start=!1)}}requestAnimationFrame(()=>this.pollGamepad())}setupMobileButtons(){document.querySelectorAll(".control-btn[data-action]").forEach(t=>{const s=t.getAttribute("data-action");t.addEventListener("touchstart",i=>{i.preventDefault(),i.stopPropagation(),this.handleMobileButtonPress(s),t.classList.add("pressed")},{passive:!1}),t.addEventListener("touchend",i=>{i.preventDefault(),i.stopPropagation(),this.handleMobileButtonRelease(s),t.classList.remove("pressed")},{passive:!1}),t.addEventListener("mousedown",i=>{i.preventDefault(),this.handleMobileButtonPress(s),t.classList.add("pressed")}),t.addEventListener("mouseup",i=>{i.preventDefault(),this.handleMobileButtonRelease(s),t.classList.remove("pressed")}),t.addEventListener("mouseleave",i=>{this.handleMobileButtonRelease(s),t.classList.remove("pressed")})})}handleMobileButtonPress(e){if(e==="pause"){this.handlePause();return}if(!(!this.game.isPlaying||this.game.isPaused))switch(e){case"left":this.handleMoveLeft(),this.startDAS("left");break;case"right":this.handleMoveRight(),this.startDAS("right");break;case"softdrop":this.handleSoftDrop();break;case"harddrop":this.handleHardDrop();break;case"rotate":this.handleRotate();break;case"hold":this.handleHold();break}}handleMobileButtonRelease(e){switch(e){case"left":case"right":this.stopDAS();break;case"softdrop":this.stopSoftDrop();break}}}let l,O=null;function T(){return(O===null||O.byteLength===0)&&(O=new Uint8Array(l.memory.buffer)),O}let D=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&D.decode();const Y=2146435072;let N=0;function q(a,e){return N+=e,N>=Y&&(D=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}},D.decode(),N=e),D.decode(T().subarray(a,a+e))}function k(a,e){return a=a>>>0,q(a,e)}function X(a,e){return a=a>>>0,T().subarray(a/1,a/1+e)}const b=new Array(128).fill(void 0);b.push(void 0,null,!0,!1);let L=b.length;function B(a){L===b.length&&b.push(b.length+1);const e=L;return L=b[e],b[e]=a,e}function G(a,e){try{return a.apply(this,e)}catch(t){l.__wbindgen_export_1(B(t))}}function $(a){return b[a]}let w=0;const A=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},K=typeof A.encodeInto=="function"?function(a,e){return A.encodeInto(a,e)}:function(a,e){const t=A.encode(a);return e.set(t),{read:a.length,written:t.length}};function C(a,e,t){if(t===void 0){const o=A.encode(a),c=e(o.length,1)>>>0;return T().subarray(c,c+o.length).set(o),w=o.length,c}let s=a.length,i=e(s,1)>>>0;const r=T();let n=0;for(;n<s;n++){const o=a.charCodeAt(n);if(o>127)break;r[i+n]=o}if(n!==s){n!==0&&(a=a.slice(n)),i=t(i,s,s=n+a.length*3,1)>>>0;const o=T().subarray(i+n,i+s),c=K(a,o);n+=c.written,i=t(i,s,n,1)>>>0}return w=n,i}let v=null;function h(){return(v===null||v.buffer.detached===!0||v.buffer.detached===void 0&&v.buffer!==l.memory.buffer)&&(v=new DataView(l.memory.buffer)),v}function V(a){a<132||(b[a]=L,L=a)}function m(a){const e=$(a);return V(a),e}const j=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(a=>l.__wbg_jsondb_free(a>>>0,1));class Z{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,j.unregister(this),e}free(){const e=this.__destroy_into_raw();l.__wbg_jsondb_free(e,0)}constructor(){try{const i=l.__wbindgen_add_to_stack_pointer(-16);l.jsondb_new(i);var e=h().getInt32(i+4*0,!0),t=h().getInt32(i+4*1,!0),s=h().getInt32(i+4*2,!0);if(s)throw m(t);return this.__wbg_ptr=e>>>0,j.register(this,this.__wbg_ptr,this),this}finally{l.__wbindgen_add_to_stack_pointer(16)}}insert(e){try{const r=l.__wbindgen_add_to_stack_pointer(-16),n=C(e,l.__wbindgen_export_2,l.__wbindgen_export_3),o=w;l.jsondb_insert(r,this.__wbg_ptr,n,o);var t=h().getInt32(r+4*0,!0),s=h().getInt32(r+4*1,!0),i=h().getInt32(r+4*2,!0);if(i)throw m(s);return m(t)}finally{l.__wbindgen_add_to_stack_pointer(16)}}get(e){try{const r=l.__wbindgen_add_to_stack_pointer(-16),n=C(e,l.__wbindgen_export_2,l.__wbindgen_export_3),o=w;l.jsondb_get(r,this.__wbg_ptr,n,o);var t=h().getInt32(r+4*0,!0),s=h().getInt32(r+4*1,!0),i=h().getInt32(r+4*2,!0);if(i)throw m(s);return m(t)}finally{l.__wbindgen_add_to_stack_pointer(16)}}update(e,t){try{const n=l.__wbindgen_add_to_stack_pointer(-16),o=C(e,l.__wbindgen_export_2,l.__wbindgen_export_3),c=w,u=C(t,l.__wbindgen_export_2,l.__wbindgen_export_3),f=w;l.jsondb_update(n,this.__wbg_ptr,o,c,u,f);var s=h().getInt32(n+4*0,!0),i=h().getInt32(n+4*1,!0),r=h().getInt32(n+4*2,!0);if(r)throw m(i);return m(s)}finally{l.__wbindgen_add_to_stack_pointer(16)}}delete(e){try{const r=l.__wbindgen_add_to_stack_pointer(-16),n=C(e,l.__wbindgen_export_2,l.__wbindgen_export_3),o=w;l.jsondb_delete(r,this.__wbg_ptr,n,o);var t=h().getInt32(r+4*0,!0),s=h().getInt32(r+4*1,!0),i=h().getInt32(r+4*2,!0);if(i)throw m(s);return m(t)}finally{l.__wbindgen_add_to_stack_pointer(16)}}stats(){try{const i=l.__wbindgen_add_to_stack_pointer(-16);l.jsondb_stats(i,this.__wbg_ptr);var e=h().getInt32(i+4*0,!0),t=h().getInt32(i+4*1,!0),s=h().getInt32(i+4*2,!0);if(s)throw m(t);return m(e)}finally{l.__wbindgen_add_to_stack_pointer(16)}}list_ids(){try{const i=l.__wbindgen_add_to_stack_pointer(-16);l.jsondb_list_ids(i,this.__wbg_ptr);var e=h().getInt32(i+4*0,!0),t=h().getInt32(i+4*1,!0),s=h().getInt32(i+4*2,!0);if(s)throw m(t);return m(e)}finally{l.__wbindgen_add_to_stack_pointer(16)}}}const Q=new Set(["basic","cors","default"]);async function ee(a,e){if(typeof Response=="function"&&a instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(a,e)}catch(s){if(a.ok&&Q.has(a.type)&&a.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",s);else throw s}const t=await a.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(a,e);return t instanceof WebAssembly.Instance?{instance:t,module:a}:t}}function te(){const a={};return a.wbg={},a.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let s,i;try{s=e,i=t,console.error(k(e,t))}finally{l.__wbindgen_export_0(s,i,1)}},a.wbg.__wbg_getRandomValues_38a1ff1ea09f6cc7=function(){return G(function(e,t){globalThis.crypto.getRandomValues(X(e,t))},arguments)},a.wbg.__wbg_log_f3c04200b995730f=function(e){console.log($(e))},a.wbg.__wbg_new_8a6f238a6ece86ea=function(){const e=new Error;return B(e)},a.wbg.__wbg_now_e3057dd824ca0191=function(){return Date.now()},a.wbg.__wbg_parse_0eaa937cfd6388c4=function(){return G(function(e,t){const s=JSON.parse(k(e,t));return B(s)},arguments)},a.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const s=$(t).stack,i=C(s,l.__wbindgen_export_2,l.__wbindgen_export_3),r=w;h().setInt32(e+4*1,r,!0),h().setInt32(e+4*0,i,!0)},a.wbg.__wbg_wbindgenthrow_4c11a24fca429ccf=function(e,t){throw new Error(k(e,t))},a.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,t){const s=k(e,t);return B(s)},a.wbg.__wbindgen_object_drop_ref=function(e){m(e)},a}function se(a,e){return l=a.exports,J.__wbindgen_wasm_module=e,v=null,O=null,l.__wbindgen_start(),l}async function J(a){if(l!==void 0)return l;typeof a<"u"&&(Object.getPrototypeOf(a)===Object.prototype?{module_or_path:a}=a:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof a>"u"&&(a=new URL("/jetrix/assets/jsonic_wasm_bg-CqPUqEIf.wasm",import.meta.url));const e=te();(typeof a=="string"||typeof Request=="function"&&a instanceof Request||typeof URL=="function"&&a instanceof URL)&&(a=fetch(a));const{instance:t,module:s}=await ee(await a,e);return se(t,s)}const ie=()=>{const{pathname:a}=window.location;if(a.startsWith("/jetrix/")){const e=document.querySelectorAll('script[src*="assets/"]');return e.length>0?e[0].src.replace(/main-[^.]+\.js$/,"")+"jsonic_wasm_bg-CqPUqEIf.wasm":"/jetrix/assets/jsonic_wasm_bg-CqPUqEIf.wasm"}return"./js/jsonic_wasm_bg.wasm"};let p={wasmUrl:ie(),debug:!0,enablePersistence:!0,persistenceKey:"jetrix_highscores"},R=!1,F=null;async function re(){if(!R)return F||(F=(async()=>{try{p.debug&&console.log("[JSONIC] Attempting to load WASM from:",p.wasmUrl),await J(p.wasmUrl),R=!0,p.debug&&console.log("[JSONIC] ✅ WASM module initialized for Jetrix")}catch(a){console.error("[JSONIC] ❌ Failed to initialize WASM:",a),console.log("[JSONIC] 🔄 Trying alternative WASM URL...");const e=["./js/jsonic_wasm_bg.wasm","/jetrix/js/jsonic_wasm_bg.wasm","../jsonic_wasm_bg.wasm"];for(const t of e)try{p.debug&&console.log("[JSONIC] Trying:",t),await J(t),R=!0,console.log("[JSONIC] ✅ WASM loaded from alternative URL:",t);return}catch(s){p.debug&&console.log("[JSONIC] Failed alternative URL:",t,s.message)}throw new Error("All WASM loading attempts failed")}})()),F}class ae{constructor(e,t={}){this.db=e,this.enablePersistence=t.enablePersistence!==!1,this.persistenceKey=t.persistenceKey||"jetrix_highscores",this.opfsRoot=null,this.initPersistence()}async initPersistence(){if(this.enablePersistence)try{"storage"in navigator&&"getDirectory"in navigator.storage?(this.opfsRoot=await navigator.storage.getDirectory(),console.log("[JSONIC] OPFS persistence enabled for Jetrix"),await this.loadFromOPFS()):console.warn("[JSONIC] OPFS not available, falling back to localStorage")}catch(e){console.error("[JSONIC] Failed to initialize persistence:",e)}}async loadFromOPFS(){var e;try{const i=await(await(await this.opfsRoot.getFileHandle(`${this.persistenceKey}.json`,{create:!1})).getFile()).text(),r=JSON.parse(i);for(const n of r.highscores||[])await this.insertScore(n);console.log(`[JSONIC] Loaded ${((e=r.highscores)==null?void 0:e.length)||0} highscores from OPFS`)}catch(t){t.name!=="NotFoundError"&&console.error("[JSONIC] Failed to load from OPFS:",t)}}async saveToOPFS(){if(this.opfsRoot)try{const e=await this.getAllScores(),s=await(await this.opfsRoot.getFileHandle(`${this.persistenceKey}.json`,{create:!0})).createWritable();await s.write(JSON.stringify({highscores:e,timestamp:Date.now(),version:"1.0.0"})),await s.close(),console.log(`[JSONIC] Saved ${e.length} highscores to OPFS`)}catch(e){console.error("[JSONIC] Failed to save to OPFS:",e)}}async insertScore(e){try{e.id||(e.id=`score_${Date.now()}_${Math.random().toString(36).substr(2,9)}`);const t=await this.db.insert(JSON.stringify(e)),s=typeof t=="string"?JSON.parse(t):t;return p.debug&&(console.log("[JSONIC] Inserted score:",e),console.log("[JSONIC] Returned ID:",s.data)),s.success&&this.enablePersistence&&await this.saveToOPFS(),s.data}catch(t){throw console.error("[JSONIC] Failed to insert score:",t),t}}async getScore(e){try{const t=await this.db.get(e),s=typeof t=="string"?JSON.parse(t):t;if(s.success){const i=s.data;return i&&i.content?i.content:i}return null}catch(t){return console.error("[JSONIC] Failed to get score:",t),null}}async updateScore(e,t){try{const s=await this.db.update(e,JSON.stringify(t)),i=typeof s=="string"?JSON.parse(s):s;return i.success&&this.enablePersistence&&await this.saveToOPFS(),i.success}catch(s){return console.error("[JSONIC] Failed to update score:",s),!1}}async deleteScore(e){try{const t=await this.db.delete(e),s=typeof t=="string"?JSON.parse(t):t;return s.success&&this.enablePersistence&&await this.saveToOPFS(),s.success}catch(t){return console.error("[JSONIC] Failed to delete score:",t),!1}}async getAllScores(){try{p.debug&&console.log("[JSONIC] getAllScores: Getting list of IDs...");const e=await this.db.list_ids(),t=typeof e=="string"?JSON.parse(e):e;p.debug&&(console.log("[JSONIC] getAllScores: Raw IDs result:",e),console.log("[JSONIC] getAllScores: Parsed IDs:",t));const s=[];for(const i of t.data||[]){p.debug&&console.log("[JSONIC] getAllScores: Getting score for ID:",i);const r=await this.getScore(i);p.debug&&console.log("[JSONIC] getAllScores: Retrieved score:",r),r&&s.push({...r,_id:i})}return p.debug&&console.log("[JSONIC] getAllScores: Final scores array:",s),s}catch(e){return console.error("[JSONIC] Failed to get all scores:",e),[]}}async findScores(e={},t={}){p.debug&&console.log("[JSONIC] findScores called with filter:",e,"options:",t);const s=await this.getAllScores();p.debug&&(console.log("[JSONIC] getAllScores returned:",s.length,"scores"),s.length>0&&console.log("[JSONIC] First score example:",s[0]));let i=s;return Object.keys(e).length>0&&(i=s.filter(r=>Object.entries(e).every(([n,o])=>{if(typeof o=="object"&&o!==null){if(o.$gt!==void 0)return r[n]>o.$gt;if(o.$gte!==void 0)return r[n]>=o.$gte;if(o.$lt!==void 0)return r[n]<o.$lt;if(o.$lte!==void 0)return r[n]<=o.$lte;if(o.$eq!==void 0)return r[n]===o.$eq;if(o.$ne!==void 0)return r[n]!==o.$ne;if(o.$in!==void 0)return o.$in.includes(r[n]);if(o.$nin!==void 0)return!o.$nin.includes(r[n])}return r[n]===o}))),t.sort&&i.sort((r,n)=>{for(const[o,c]of Object.entries(t.sort)){const u=r[o],f=n[o];if(u!==f)return c===-1?f>u?1:-1:u>f?1:-1}return 0}),t.skip&&(i=i.slice(t.skip)),t.limit&&(i=i.slice(0,t.limit)),i}async findOneScore(e={}){return(await this.findScores(e,{limit:1}))[0]||null}async countScores(e={}){return(await this.findScores(e)).length}async getStats(){try{const e=await this.db.stats(),t=typeof e=="string"?JSON.parse(e):e,s=await this.getAllScores();return{totalScores:s.length,uniquePlayers:new Set(s.map(i=>i.playerId)).size,gameModes:new Set(s.map(i=>i.gameMode)).size,highestScore:Math.max(...s.map(i=>i.score),0),lastUpdated:Math.max(...s.map(i=>i.timestamp),0),wasmStats:t.data||{}}}catch(e){return console.error("[JSONIC] Failed to get stats:",e),{totalScores:0,uniquePlayers:0,gameModes:0,highestScore:0}}}}const E={version:"1.0.0",configure(a){p={...p,...a},p.debug&&console.log("[JSONIC] Configuration updated for Jetrix:",p)},async createDatabase(a={}){await re();const e=new Z,t={...p,...a};return new ae(e,t)}};typeof window<"u"&&(window.JSONIC=E,window.JSONIC_READY=Promise.resolve(E),setTimeout(()=>{window.dispatchEvent(new CustomEvent("jsonic-ready",{detail:E}))},0));class U{constructor(){this.db=null,this.playerId=null,this.leaderboardCache=new Map,this.updateCallbacks=new Set,this.isInitialized=!1}async initialize(){if(!this.isInitialized)try{this.playerId=localStorage.getItem("playerId"),this.playerId||(this.playerId=this.generatePlayerId(),localStorage.setItem("playerId",this.playerId)),E.configure({debug:!1,enablePersistence:!0,persistenceKey:"jetrix_highscores"}),this.db=await E.createDatabase(),console.log("✅ JSONIC highscore database initialized successfully"),await this.loadMiniLeaderboard(),this.isInitialized=!0}catch(e){console.error("❌ Failed to initialize JSONIC database:",e),console.log("📦 Falling back to localStorage..."),this.useFallbackStorage(),await this.loadMiniLeaderboard(),this.isInitialized=!0}}generatePlayerId(){return"player_"+Math.random().toString(36).substr(2,9)+Date.now().toString(36)}async submitScore(e){this.isInitialized||await this.initialize();const t={isHighscore:!1,rank:null,personalBest:null};try{if(!this.db)return this.submitScoreFallback(e);const s=await this.getPersonalBest(e.gameMode);if(t.personalBest=(s==null?void 0:s.score)||0,!s||e.score>s.score){const i={playerId:this.playerId,playerName:e.playerName||"Anonymous",score:e.score,level:e.level,lines:e.lines,gameMode:e.gameMode,timestamp:Date.now(),metadata:e.metadata||{}};await this.db.insertScore(i),t.rank=await this.getRank(e.score,e.gameMode),t.isHighscore=!0,this.leaderboardCache.clear(),await this.loadMiniLeaderboard(),this.notifySubscribers(),console.log(`🏆 New highscore saved: ${e.score} (Rank #${t.rank})`)}}catch(s){return console.error("Failed to submit score to JSONIC:",s),this.submitScoreFallback(e)}return t}async getPersonalBest(e){if(!this.db)return this.getPersonalBestFallback(e);try{return(await this.db.findScores({playerId:this.playerId,gameMode:e},{sort:{score:-1},limit:1}))[0]||null}catch(t){return console.error("Failed to get personal best:",t),this.getPersonalBestFallback(e)}}async getRank(e,t){if(!this.db)return this.getLocalScores().filter(r=>r.gameMode===t&&r.score>e).length+1;try{return await this.db.countScores({gameMode:t,score:{$gt:e}})+1}catch(s){return console.error("Failed to get rank:",s),999}}async getLeaderboard(e="normal",t="all",s=100){const i=`${e}-${t}-${s}`;if(this.leaderboardCache.has(i)){const r=this.leaderboardCache.get(i);if(Date.now()-r.timestamp<3e4)return r.data}if(!this.db)return this.getLeaderboardFallback(e,t,s);try{const r={gameMode:e};t!=="all"&&(r.timestamp={$gte:this.getTimeCutoff(t)}),console.log("🔍 Getting leaderboard with filter:",r);const n=await this.db.findScores(r,{sort:{score:-1},limit:s});console.log("📊 Found scores:",n);const o=n.map((c,u)=>({rank:u+1,playerId:c.playerId,playerName:c.playerName,score:c.score,level:c.level,lines:c.lines,timestamp:c.timestamp,isCurrentPlayer:c.playerId===this.playerId}));return this.leaderboardCache.set(i,{data:o,timestamp:Date.now()}),o}catch(r){return console.error("Failed to get leaderboard from JSONIC:",r),this.getLeaderboardFallback(e,t,s)}}getTimeCutoff(e){const t=Date.now();switch(e){case"daily":return t-24*60*60*1e3;case"weekly":return t-7*24*60*60*1e3;case"monthly":return t-30*24*60*60*1e3;default:return 0}}async loadMiniLeaderboard(){try{const e=await this.getLeaderboard("normal","all",5);this.updateMiniLeaderboard(e)}catch(e){console.error("Failed to load mini leaderboard:",e),this.updateMiniLeaderboard([])}}updateMiniLeaderboard(e){const t=document.getElementById("miniLeaderboard");if(t){if(e.length===0){t.innerHTML='<div class="no-scores">No scores yet</div>';return}t.innerHTML=e.map(s=>`
            <div class="mini-score-entry ${s.isCurrentPlayer?"current-player":""}">
                <span class="rank">#${s.rank}</span>
                <span class="name">${this.truncateName(s.playerName,10)}</span>
                <span class="score">${s.score.toLocaleString()}</span>
            </div>
        `).join("")}}async displayLeaderboard(){document.getElementById("leaderboardContent")&&(this.setupLeaderboardTabs(),await this.loadLeaderboardContent("normal","all"))}setupLeaderboardTabs(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",async t=>{var r;document.querySelectorAll(".tab-btn").forEach(n=>n.classList.remove("active")),t.target.classList.add("active");const s=t.target.dataset.range,i=((r=document.querySelector(".mode-btn.active"))==null?void 0:r.dataset.mode)||"normal";await this.loadLeaderboardContent(i,s)})}),document.querySelectorAll(".mode-btn").forEach(e=>{e.addEventListener("click",async t=>{var r;document.querySelectorAll(".mode-btn").forEach(n=>n.classList.remove("active")),t.target.classList.add("active");const s=t.target.dataset.mode,i=((r=document.querySelector(".tab-btn.active"))==null?void 0:r.dataset.range)||"all";await this.loadLeaderboardContent(s,i)})})}async loadLeaderboardContent(e,t){const s=document.getElementById("leaderboardContent");if(s){s.innerHTML='<div class="loading">Loading scores...</div>';try{const i=await this.getLeaderboard(e,t,50);if(i.length===0){s.innerHTML='<div class="no-scores">No scores recorded yet. Be the first!</div>';return}s.innerHTML=`
                <div class="leaderboard-table">
                    <div class="leaderboard-header">
                        <span class="col-rank">RANK</span>
                        <span class="col-name">PLAYER</span>
                        <span class="col-score">SCORE</span>
                        <span class="col-level">LEVEL</span>
                        <span class="col-lines">LINES</span>
                        <span class="col-date">DATE</span>
                    </div>
                    <div class="leaderboard-entries">
                        ${i.map(r=>this.renderLeaderboardEntry(r)).join("")}
                    </div>
                </div>
            `}catch(i){console.error("Failed to load leaderboard content:",i),s.innerHTML='<div class="no-scores">Failed to load leaderboard. Please try again.</div>'}}}renderLeaderboardEntry(e){const t=new Date(e.timestamp),s=t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:t.getFullYear()!==new Date().getFullYear()?"numeric":void 0});return`
            <div class="leaderboard-entry ${e.isCurrentPlayer?"current-player":""}">
                <span class="col-rank">
                    ${e.rank<=3?this.getRankMedal(e.rank):""}
                    #${e.rank}
                </span>
                <span class="col-name">${this.truncateName(e.playerName,15)}</span>
                <span class="col-score">${e.score.toLocaleString()}</span>
                <span class="col-level">${e.level}</span>
                <span class="col-lines">${e.lines}</span>
                <span class="col-date">${s}</span>
            </div>
        `}getRankMedal(e){switch(e){case 1:return"🥇";case 2:return"🥈";case 3:return"🥉";default:return""}}truncateName(e,t){return e.length<=t?e:e.substr(0,t-3)+"..."}subscribe(e){return this.updateCallbacks.add(e),()=>this.updateCallbacks.delete(e)}notifySubscribers(){this.updateCallbacks.forEach(e=>e())}async getStats(){if(!this.db){const e=this.getLocalScores();return{totalScores:e.length,uniquePlayers:new Set(e.map(t=>t.playerId)).size,highestScore:Math.max(...e.map(t=>t.score),0)}}try{return await this.db.getStats()}catch(e){return console.error("Failed to get stats:",e),{totalScores:0,uniquePlayers:0,highestScore:0}}}useFallbackStorage(){console.log("📦 Using localStorage fallback for highscores"),this.db=null}submitScoreFallback(e){var i;const t=this.getLocalScores();t.push({...e,playerId:this.playerId,timestamp:Date.now()}),t.sort((r,n)=>n.score-r.score),t.splice(100),localStorage.setItem("jetrix_scores",JSON.stringify(t));const s=t.findIndex(r=>r.playerId===this.playerId&&r.score===e.score)+1;return{isHighscore:s<=100,rank:s,personalBest:((i=this.getPersonalBestFallback(e.gameMode))==null?void 0:i.score)||0}}getPersonalBestFallback(e){const s=this.getLocalScores().filter(i=>i.playerId===this.playerId&&i.gameMode===e);return s.length===0?null:s.reduce((i,r)=>r.score>i.score?r:i)}getLeaderboardFallback(e,t,s){const i=this.getLocalScores(),r=this.getTimeCutoff(t);return i.filter(o=>o.gameMode===e&&o.timestamp>=r).slice(0,s).map((o,c)=>({rank:c+1,playerId:o.playerId,playerName:o.playerName||"Anonymous",score:o.score,level:o.level||1,lines:o.lines||0,timestamp:o.timestamp,isCurrentPlayer:o.playerId===this.playerId}))}getLocalScores(){try{const e=localStorage.getItem("jetrix_scores");return e?JSON.parse(e):[]}catch{return[]}}}const M={I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:"#00ffff"},O:{shape:[[1,1],[1,1]],color:"#ffff00"},T:{shape:[[0,1,0],[1,1,1],[0,0,0]],color:"#ff00ff"},S:{shape:[[0,1,1],[1,1,0],[0,0,0]],color:"#00ff00"},Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],color:"#ff0000"},J:{shape:[[1,0,0],[1,1,1],[0,0,0]],color:"#0000ff"},L:{shape:[[0,0,1],[1,1,1],[0,0,0]],color:"#ff8800"}},g={BOARD_WIDTH:10,BOARD_HEIGHT:20,LOCK_DELAY:500,POINTS:{SINGLE:100,DOUBLE:300,TRIPLE:500,TETRIS:800,SOFT_DROP:1,HARD_DROP:2,COMBO_MULTIPLIER:50},DIFFICULTY:{easy:{speed:1e3,levelSpeed:80},normal:{speed:800,levelSpeed:60},hard:{speed:600,levelSpeed:40},extreme:{speed:400,levelSpeed:20}}};class ne{constructor(){this.board=[],this.currentPiece=null,this.nextPieces=[],this.holdPiece=null,this.canHold=!0,this.score=0,this.level=1,this.lines=0,this.combo=0,this.gameMode="normal",this.isPlaying=!1,this.isPaused=!1,this.isGameOver=!1,this.dropTimer=0,this.lockTimer=0,this.bag=[],this.renderer=null,this.controls=null,this.highscores=null,this.playerName="Player",this.stats={piecesPlaced:0,tSpins:0,maxCombo:0,startTime:0,endTime:0}}async initialize(){this.resetBoard(),this.renderer=new W(this),this.renderer.initialize(),this.controls=new z(this),this.controls.initialize(),this.highscores=new U,await this.highscores.initialize(),this.setupUI(),this.showStartModal()}resetBoard(){this.board=Array(g.BOARD_HEIGHT).fill(null).map(()=>Array(g.BOARD_WIDTH).fill(0))}setupUI(){var i,r,n,o,c;const e=document.getElementById("startGame");e==null||e.addEventListener("click",()=>this.startGame()),document.querySelectorAll(".btn-difficulty").forEach(u=>{u.addEventListener("click",f=>{document.querySelectorAll(".btn-difficulty").forEach(I=>I.classList.remove("active")),f.target.classList.add("active"),this.gameMode=f.target.dataset.mode})});const t=document.getElementById("playerName");t==null||t.addEventListener("change",u=>{this.playerName=u.target.value||"Player",localStorage.setItem("playerName",this.playerName)});const s=localStorage.getItem("playerName");s&&t&&(t.value=s,this.playerName=s),(i=document.getElementById("viewHighscores"))==null||i.addEventListener("click",()=>{this.showHighscoresModal()}),(r=document.getElementById("closeHighscores"))==null||r.addEventListener("click",()=>{document.getElementById("highscoreModal").style.display="none"}),(n=document.getElementById("playAgain"))==null||n.addEventListener("click",()=>{this.hideGameOverModal(),this.startGame()}),(o=document.getElementById("mainMenu"))==null||o.addEventListener("click",()=>{this.hideGameOverModal(),this.showStartModal()}),(c=document.getElementById("overlayButton"))==null||c.addEventListener("click",()=>{this.isPaused&&this.resume()})}showStartModal(){document.getElementById("startModal").style.display="flex",document.getElementById("gameOverModal").style.display="none",document.getElementById("highscoreModal").style.display="none"}hideStartModal(){document.getElementById("startModal").style.display="none"}showHighscoresModal(){document.getElementById("highscoreModal").style.display="flex",this.highscores.displayLeaderboard()}showGameOverModal(){const e=document.getElementById("gameOverModal");document.getElementById("finalScore").textContent=this.score.toLocaleString(),document.getElementById("finalLevel").textContent=this.level,document.getElementById("finalLines").textContent=this.lines,e.style.display="flex"}hideGameOverModal(){document.getElementById("gameOverModal").style.display="none"}async startGame(){this.resetBoard(),this.score=0,this.level=1,this.lines=0,this.combo=0,this.isPlaying=!0,this.isPaused=!1,this.isGameOver=!1,this.holdPiece=null,this.canHold=!0,this.bag=[],this.nextPieces=[],this.stats={piecesPlaced:0,tSpins:0,maxCombo:0,startTime:Date.now(),endTime:0},this.hideStartModal(),this.hideGameOverModal(),this.updateDisplay();for(let e=0;e<3;e++)this.nextPieces.push(this.getNextFromBag());this.spawnPiece(),this.gameLoop()}gameLoop(e=0){if(!(!this.isPlaying||this.isGameOver)){if(!this.isPaused){const t=this.getDropSpeed();this.dropTimer+=16.67,this.dropTimer>=t&&(this.dropTimer=0,this.moveDown()?this.lockTimer=0:(this.lockTimer+=t,this.lockTimer>=g.LOCK_DELAY&&this.lockPiece()))}this.renderer.render(),requestAnimationFrame(t=>this.gameLoop(t))}}getDropSpeed(){const e=g.DIFFICULTY[this.gameMode],t=e.speed,s=e.levelSpeed*(this.level-1);return Math.max(50,t-s)}getNextFromBag(){if(this.bag.length===0){this.bag=["I","O","T","S","Z","J","L"];for(let e=this.bag.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this.bag[e],this.bag[t]]=[this.bag[t],this.bag[e]]}}return this.bag.pop()}spawnPiece(){const e=this.nextPieces.shift();this.nextPieces.push(this.getNextFromBag());const t=M[e].shape,s=M[e].color;this.currentPiece={type:e,shape:t,color:s,x:Math.floor((g.BOARD_WIDTH-t[0].length)/2),y:0,rotation:0},this.isValidPosition(this.currentPiece.x,this.currentPiece.y,t)||this.gameOver(),this.canHold=!0,this.dropTimer=0,this.lockTimer=0}isValidPosition(e,t,s){for(let i=0;i<s.length;i++)for(let r=0;r<s[i].length;r++)if(s[i][r]){const n=e+r,o=t+i;if(n<0||n>=g.BOARD_WIDTH||o>=g.BOARD_HEIGHT||o>=0&&this.board[o][n])return!1}return!0}moveLeft(){return!this.currentPiece||this.isPaused?!1:this.isValidPosition(this.currentPiece.x-1,this.currentPiece.y,this.currentPiece.shape)?(this.currentPiece.x--,this.lockTimer=0,!0):!1}moveRight(){return!this.currentPiece||this.isPaused?!1:this.isValidPosition(this.currentPiece.x+1,this.currentPiece.y,this.currentPiece.shape)?(this.currentPiece.x++,this.lockTimer=0,!0):!1}moveDown(){return!this.currentPiece||this.isPaused?!1:this.isValidPosition(this.currentPiece.x,this.currentPiece.y+1,this.currentPiece.shape)?(this.currentPiece.y++,this.score+=g.POINTS.SOFT_DROP,!0):!1}hardDrop(){if(!this.currentPiece||this.isPaused)return;let e=0;for(;this.isValidPosition(this.currentPiece.x,this.currentPiece.y+1,this.currentPiece.shape);)this.currentPiece.y++,e++;this.score+=e*g.POINTS.HARD_DROP,this.lockPiece(),this.playSound("drop")}rotate(e=!0){if(!this.currentPiece||this.isPaused)return!1;const t=this.rotateMatrix(this.currentPiece.shape,e);if(this.isValidPosition(this.currentPiece.x,this.currentPiece.y,t))return this.currentPiece.shape=t,this.currentPiece.rotation=(this.currentPiece.rotation+(e?1:3))%4,this.lockTimer=0,this.checkTSpin(),!0;const s=this.getWallKicks(this.currentPiece.type,this.currentPiece.rotation,e);for(const[i,r]of s)if(this.isValidPosition(this.currentPiece.x+i,this.currentPiece.y+r,t))return this.currentPiece.x+=i,this.currentPiece.y+=r,this.currentPiece.shape=t,this.currentPiece.rotation=(this.currentPiece.rotation+(e?1:3))%4,this.lockTimer=0,this.checkTSpin(),!0;return!1}rotateMatrix(e,t=!0){const s=e.length,i=Array(s).fill(null).map(()=>Array(s).fill(0));for(let r=0;r<s;r++)for(let n=0;n<s;n++)t?i[n][s-1-r]=e[r][n]:i[s-1-n][r]=e[r][n];return i}getWallKicks(e,t,s){return e==="I"?[[-1,0],[2,0],[-1,2],[2,-1]]:e==="O"?[]:[[-1,0],[1,0],[-1,-1],[1,-1],[0,1]]}checkTSpin(){if(this.currentPiece.type!=="T")return!1;const e=[[this.currentPiece.x-1,this.currentPiece.y-1],[this.currentPiece.x+1,this.currentPiece.y-1],[this.currentPiece.x-1,this.currentPiece.y+1],[this.currentPiece.x+1,this.currentPiece.y+1]];let t=0;for(const[s,i]of e)(s<0||s>=g.BOARD_WIDTH||i>=g.BOARD_HEIGHT||i>=0&&this.board[i][s])&&t++;return t>=3?(this.stats.tSpins++,!0):!1}hold(){if(!this.currentPiece||!this.canHold||this.isPaused)return;const e=this.currentPiece.type;if(this.holdPiece){const t=this.holdPiece;this.holdPiece=e;const s=M[t].shape,i=M[t].color;this.currentPiece={type:t,shape:s,color:i,x:Math.floor((g.BOARD_WIDTH-s[0].length)/2),y:0,rotation:0}}else this.holdPiece=e,this.spawnPiece();this.canHold=!1,this.renderer.renderHold()}lockPiece(){if(!this.currentPiece)return;const e=this.currentPiece.shape;for(let s=0;s<e.length;s++)for(let i=0;i<e[s].length;i++)if(e[s][i]){const r=this.currentPiece.y+s,n=this.currentPiece.x+i;r>=0&&(this.board[r][n]=this.currentPiece.color)}this.stats.piecesPlaced++;const t=this.clearLines();t>0?(this.updateScore(t),this.combo++,this.stats.maxCombo=Math.max(this.stats.maxCombo,this.combo)):this.combo=0,this.spawnPiece()}clearLines(){let e=0;for(let t=g.BOARD_HEIGHT-1;t>=0;t--)this.board[t].every(s=>s!==0)&&(this.board.splice(t,1),this.board.unshift(Array(g.BOARD_WIDTH).fill(0)),e++,t++);if(e>0){this.lines+=e;const t=Math.floor(this.lines/10)+1;t>this.level&&(this.level=t,this.playSound("levelUp")),e===4?this.playSound("tetris"):this.playSound("clear"),this.renderer.animateLineClear(e)}return e}updateScore(e){let t=0;switch(e){case 1:t=g.POINTS.SINGLE;break;case 2:t=g.POINTS.DOUBLE;break;case 3:t=g.POINTS.TRIPLE;break;case 4:t=g.POINTS.TETRIS;break}t*=this.level,this.combo>0&&(t+=g.POINTS.COMBO_MULTIPLIER*this.combo),this.score+=t,this.updateDisplay()}updateDisplay(){document.getElementById("score").textContent=this.score.toLocaleString(),document.getElementById("level").textContent=this.level,document.getElementById("lines").textContent=this.lines}pause(){if(!this.isPlaying||this.isGameOver)return;this.isPaused=!0;const e=document.getElementById("gameOverlay");e.style.display="flex",document.getElementById("overlayTitle").textContent="PAUSED",document.getElementById("overlayMessage").textContent="Press SPACE or ESC to continue"}resume(){this.isPaused=!1,document.getElementById("gameOverlay").style.display="none"}async gameOver(){this.isGameOver=!0,this.isPlaying=!1,this.stats.endTime=Date.now(),this.playSound("gameOver");const e=await this.highscores.submitScore({playerName:this.playerName,score:this.score,level:this.level,lines:this.lines,gameMode:this.gameMode,metadata:{piecesPlaced:this.stats.piecesPlaced,tSpins:this.stats.tSpins,maxCombo:this.stats.maxCombo,timeElapsed:this.stats.endTime-this.stats.startTime}});if(e.isHighscore){const t=document.getElementById("highscoreRank"),s=document.getElementById("rankNumber");t.style.display="flex",s.textContent=e.rank}else document.getElementById("highscoreRank").style.display="none";setTimeout(()=>this.showGameOverModal(),1e3)}playSound(e){}getGhostPosition(){if(!this.currentPiece)return null;let e=this.currentPiece.y;for(;this.isValidPosition(this.currentPiece.x,e+1,this.currentPiece.shape);)e++;return{x:this.currentPiece.x,y:e,shape:this.currentPiece.shape,color:this.currentPiece.color}}}window.addEventListener("DOMContentLoaded",async()=>{const a=new ne,e=new U;await a.initialize(),await e.initialize(),window.game=a,window.highscores=e});
