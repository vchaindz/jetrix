(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();class U{constructor(e){this.game=e,this.canvas=null,this.ctx=null,this.nextCanvas=null,this.nextCtx=null,this.holdCanvas=null,this.holdCtx=null,this.cellSize=30,this.animationFrame=0,this.lineClearAnimation=null,this.particles=[]}initialize(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.nextCanvas=document.getElementById("nextCanvas"),this.nextCtx=this.nextCanvas.getContext("2d"),this.holdCanvas=document.getElementById("holdCanvas"),this.holdCtx=this.holdCanvas.getContext("2d"),[this.ctx,this.nextCtx,this.holdCtx].forEach(e=>{e.imageSmoothingEnabled=!1}),this.initParticles()}initParticles(){for(let e=0;e<20;e++)this.particles.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,vx:(Math.random()-.5)*.5,vy:Math.random()*.5+.5,size:Math.random()*2+1,opacity:Math.random()*.5+.1})}render(){this.clearCanvas(),this.drawGrid(),this.drawBoard(),this.drawGhostPiece(),this.drawCurrentPiece(),this.drawParticles(),this.renderNext(),this.renderHold(),this.animationFrame++,this.lineClearAnimation&&this.drawLineClearAnimation()}clearCanvas(){const e=this.ctx.createLinearGradient(0,0,0,this.canvas.height);e.addColorStop(0,"#0a0a0a"),e.addColorStop(1,"#1a0a2a"),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawGrid(){this.ctx.strokeStyle="rgba(255, 255, 255, 0.05)",this.ctx.lineWidth=1;for(let e=0;e<=10;e++)this.ctx.beginPath(),this.ctx.moveTo(e*this.cellSize,0),this.ctx.lineTo(e*this.cellSize,this.canvas.height),this.ctx.stroke();for(let e=0;e<=20;e++)this.ctx.beginPath(),this.ctx.moveTo(0,e*this.cellSize),this.ctx.lineTo(this.canvas.width,e*this.cellSize),this.ctx.stroke()}drawBoard(){const e=this.game.board;for(let t=0;t<e.length;t++)for(let s=0;s<e[t].length;s++)e[t][s]&&this.drawCell(s,t,e[t][s],1)}drawCurrentPiece(){const e=this.game.currentPiece;if(!e)return;const t=e.shape;for(let s=0;s<t.length;s++)for(let r=0;r<t[s].length;r++)t[s][r]&&this.drawCell(e.x+r,e.y+s,e.color,1)}drawGhostPiece(){const e=this.game.getGhostPosition();if(!e)return;const t=e.shape;for(let s=0;s<t.length;s++)for(let r=0;r<t[s].length;r++)t[s][r]&&this.drawCell(e.x+r,e.y+s,e.color,.2)}drawCell(e,t,s,r=1){const i=e*this.cellSize,a=t*this.cellSize,n=this.cellSize,l=1,d=this.ctx.createLinearGradient(i,a,i+n,a+n),h=this.hexToRgb(s);d.addColorStop(0,`rgba(${h.r}, ${h.g}, ${h.b}, ${r})`),d.addColorStop(1,`rgba(${h.r*.6}, ${h.g*.6}, ${h.b*.6}, ${r})`),this.ctx.fillStyle=d,this.ctx.fillRect(i+l,a+l,n-l*2,n-l*2),r>.5&&(this.ctx.shadowColor=s,this.ctx.shadowBlur=10,this.ctx.strokeStyle=s,this.ctx.lineWidth=1,this.ctx.strokeRect(i+l,a+l,n-l*2,n-l*2),this.ctx.shadowBlur=0),this.ctx.strokeStyle=`rgba(255, 255, 255, ${r*.3})`,this.ctx.lineWidth=1,this.ctx.strokeRect(i+l+2,a+l+2,n-l*2-4,n-l*2-4)}renderNext(){const e=this.nextCtx.createLinearGradient(0,0,0,this.nextCanvas.height);e.addColorStop(0,"rgba(10, 10, 10, 0.8)"),e.addColorStop(1,"rgba(26, 10, 42, 0.8)"),this.nextCtx.fillStyle=e,this.nextCtx.fillRect(0,0,this.nextCanvas.width,this.nextCanvas.height);const t=this.game.nextPieces,s={I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:"#00ffff"},O:{shape:[[1,1],[1,1]],color:"#ffff00"},T:{shape:[[0,1,0],[1,1,1],[0,0,0]],color:"#ff00ff"},S:{shape:[[0,1,1],[1,1,0],[0,0,0]],color:"#00ff00"},Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],color:"#ff0000"},J:{shape:[[1,0,0],[1,1,1],[0,0,0]],color:"#0000ff"},L:{shape:[[0,0,1],[1,1,1],[0,0,0]],color:"#ff8800"}};for(let r=0;r<Math.min(3,t.length);r++){const i=s[t[r]];i&&this.drawPiecePreview(this.nextCtx,i.shape,i.color,60,40+r*120,20)}}renderHold(){const e=this.holdCtx.createLinearGradient(0,0,0,this.holdCanvas.height);if(e.addColorStop(0,"rgba(10, 10, 10, 0.8)"),e.addColorStop(1,"rgba(26, 10, 42, 0.8)"),this.holdCtx.fillStyle=e,this.holdCtx.fillRect(0,0,this.holdCanvas.width,this.holdCanvas.height),this.game.holdPiece){const s={I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:"#00ffff"},O:{shape:[[1,1],[1,1]],color:"#ffff00"},T:{shape:[[0,1,0],[1,1,1],[0,0,0]],color:"#ff00ff"},S:{shape:[[0,1,1],[1,1,0],[0,0,0]],color:"#00ff00"},Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],color:"#ff0000"},J:{shape:[[1,0,0],[1,1,1],[0,0,0]],color:"#0000ff"},L:{shape:[[0,0,1],[1,1,1],[0,0,0]],color:"#ff8800"}}[this.game.holdPiece];if(s){const r=this.game.canHold?1:.3;this.drawPiecePreview(this.holdCtx,s.shape,s.color,60,60,20,r)}}}drawPiecePreview(e,t,s,r,i,a,n=1){const l=t[0].length,d=t.length,h=r-l*a/2,I=i-d*a/2;for(let S=0;S<d;S++)for(let _=0;_<l;_++)if(t[S][_]){const v=h+_*a,u=I+S*a,C=e.createLinearGradient(v,u,v+a,u+a),b=this.hexToRgb(s);C.addColorStop(0,`rgba(${b.r}, ${b.g}, ${b.b}, ${n})`),C.addColorStop(1,`rgba(${b.r*.6}, ${b.g*.6}, ${b.b*.6}, ${n})`),e.fillStyle=C,e.fillRect(v+1,u+1,a-2,a-2),e.strokeStyle=`rgba(255, 255, 255, ${n*.3})`,e.lineWidth=1,e.strokeRect(v+1,u+1,a-2,a-2)}}drawParticles(){this.ctx.save();for(let e of this.particles)e.x+=e.vx,e.y+=e.vy,e.y>this.canvas.height&&(e.y=-10,e.x=Math.random()*this.canvas.width),e.x<0&&(e.x=this.canvas.width),e.x>this.canvas.width&&(e.x=0),this.ctx.fillStyle=`rgba(255, 255, 255, ${e.opacity})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.fill();this.ctx.restore()}animateLineClear(e){this.lineClearAnimation={lines:e,frame:0,maxFrames:30}}drawLineClearAnimation(){const e=this.lineClearAnimation,t=e.frame/e.maxFrames;if(e.frame<10&&(this.ctx.fillStyle=`rgba(255, 255, 255, ${.3*(1-t*3)})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)),e.frame===0)for(let s=0;s<e.lines*10;s++)this.particles.push({x:Math.random()*this.canvas.width,y:this.canvas.height*.7,vx:(Math.random()-.5)*5,vy:-Math.random()*5-2,size:Math.random()*3+2,opacity:1,lifetime:30});e.frame++,e.frame>=e.maxFrames&&(this.lineClearAnimation=null),this.particles=this.particles.filter(s=>!s.lifetime||--s.lifetime>0)}hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:255,g:255,b:255}}}class W{constructor(e){this.game=e,this.keys={},this.keyTimers={},this.dasTimer=null,this.arrTimer=null,this.touchStartX=null,this.touchStartY=null,this.touchStartTime=null}initialize(){this.setupKeyboardControls(),this.setupTouchControls(),this.setupGamepadControls()}setupKeyboardControls(){document.addEventListener("keydown",e=>this.handleKeyDown(e)),document.addEventListener("keyup",e=>this.handleKeyUp(e))}handleKeyDown(e){if(["ArrowLeft","ArrowRight","ArrowDown","ArrowUp"," ","c","C","Escape"].includes(e.key)&&e.preventDefault(),!this.keys[e.key])switch(this.keys[e.key]=!0,e.key){case"ArrowLeft":this.handleMoveLeft(),this.startDAS("left");break;case"ArrowRight":this.handleMoveRight(),this.startDAS("right");break;case"ArrowDown":this.handleSoftDrop();break;case"ArrowUp":this.handleRotate();break;case"z":case"Z":this.handleRotate(!1);break;case" ":this.handleHardDrop();break;case"c":case"C":this.handleHold();break;case"Escape":this.handlePause();break;case"Enter":this.game.isGameOver&&this.game.startGame();break}}handleKeyUp(e){delete this.keys[e.key],(e.key==="ArrowLeft"||e.key==="ArrowRight")&&this.stopDAS(),e.key==="ArrowDown"&&this.stopSoftDrop()}handleMoveLeft(){!this.game.isPlaying||this.game.isPaused||(this.game.moveLeft(),this.game.playSound("move"))}handleMoveRight(){!this.game.isPlaying||this.game.isPaused||(this.game.moveRight(),this.game.playSound("move"))}handleRotate(e=!0){!this.game.isPlaying||this.game.isPaused||this.game.rotate(e)&&this.game.playSound("rotate")}handleSoftDrop(){!this.game.isPlaying||this.game.isPaused||(this.game.moveDown(),this.keyTimers.softDrop||(this.keyTimers.softDrop=setInterval(()=>{this.keys.ArrowDown&&!this.game.isPaused&&this.game.moveDown()},50)))}stopSoftDrop(){this.keyTimers.softDrop&&(clearInterval(this.keyTimers.softDrop),this.keyTimers.softDrop=null)}handleHardDrop(){!this.game.isPlaying||this.game.isPaused||this.game.hardDrop()}handleHold(){!this.game.isPlaying||this.game.isPaused||(this.game.hold(),this.game.playSound("move"))}handlePause(){this.game.isPlaying&&(this.game.isPaused?this.game.resume():this.game.pause())}startDAS(e){this.stopDAS(),this.dasTimer=setTimeout(()=>{this.arrTimer=setInterval(()=>{this.game.isPaused||(e==="left"&&this.keys.ArrowLeft?this.game.moveLeft():e==="right"&&this.keys.ArrowRight?this.game.moveRight():this.stopDAS())},30)},150)}stopDAS(){this.dasTimer&&(clearTimeout(this.dasTimer),this.dasTimer=null),this.arrTimer&&(clearInterval(this.arrTimer),this.arrTimer=null)}setupTouchControls(){const e=document.getElementById("gameCanvas");e.addEventListener("touchstart",t=>this.handleTouchStart(t),{passive:!1}),e.addEventListener("touchmove",t=>this.handleTouchMove(t),{passive:!1}),e.addEventListener("touchend",t=>this.handleTouchEnd(t),{passive:!1}),this.setupMobileButtons()}handleTouchStart(e){e.preventDefault();const t=e.touches[0];this.touchStartX=t.clientX,this.touchStartY=t.clientY,this.touchStartTime=Date.now()}handleTouchMove(e){if(e.preventDefault(),!this.touchStartX||!this.touchStartY)return;const t=e.touches[0],s=t.clientX-this.touchStartX,r=t.clientY-this.touchStartY,i=25;Math.abs(s)>i&&Math.abs(s)>Math.abs(r)&&(s>0?this.handleMoveRight():this.handleMoveLeft(),this.touchStartX=t.clientX),r>i&&Math.abs(r)>Math.abs(s)&&(this.handleSoftDrop(),this.touchStartY=t.clientY)}handleTouchEnd(e){if(e.preventDefault(),!this.touchStartTime)return;const t=Date.now()-this.touchStartTime,s=e.changedTouches[0],r=Math.abs(s.clientX-this.touchStartX),i=Math.abs(s.clientY-this.touchStartY);t<250&&r<15&&i<15&&this.handleRotate(),t<300&&i>40&&s.clientY-this.touchStartY<-40&&this.handleHardDrop(),this.touchStartX=null,this.touchStartY=null,this.touchStartTime=null,this.stopSoftDrop()}setupGamepadControls(){this.gamepadIndex=null,this.gamepadButtons={},window.addEventListener("gamepadconnected",e=>{console.log("Gamepad connected:",e.gamepad.id),this.gamepadIndex=e.gamepad.index}),window.addEventListener("gamepaddisconnected",e=>{console.log("Gamepad disconnected:",e.gamepad.id),this.gamepadIndex===e.gamepad.index&&(this.gamepadIndex=null)}),this.pollGamepad()}pollGamepad(){var e,t,s,r,i,a,n,l,d,h,I,S,_,v;if(this.gamepadIndex!==null){const u=navigator.getGamepads()[this.gamepadIndex];if(u){const C=((e=u.buttons[14])==null?void 0:e.pressed)||u.axes[0]<-.5,b=((t=u.buttons[15])==null?void 0:t.pressed)||u.axes[0]>.5,H=((s=u.buttons[13])==null?void 0:s.pressed)||u.axes[1]>.5;(r=u.buttons[12])!=null&&r.pressed||u.axes[1]<-.5,C&&!this.gamepadButtons.left?(this.handleMoveLeft(),this.gamepadButtons.left=!0):C||(this.gamepadButtons.left=!1),b&&!this.gamepadButtons.right?(this.handleMoveRight(),this.gamepadButtons.right=!0):b||(this.gamepadButtons.right=!1),H&&!this.gamepadButtons.down?(this.handleSoftDrop(),this.gamepadButtons.down=!0):H||(this.gamepadButtons.down=!1,this.stopSoftDrop()),(i=u.buttons[0])!=null&&i.pressed&&!this.gamepadButtons.a?(this.handleRotate(),this.gamepadButtons.a=!0):(a=u.buttons[0])!=null&&a.pressed||(this.gamepadButtons.a=!1),(n=u.buttons[1])!=null&&n.pressed&&!this.gamepadButtons.b?(this.handleRotate(!1),this.gamepadButtons.b=!0):(l=u.buttons[1])!=null&&l.pressed||(this.gamepadButtons.b=!1),(d=u.buttons[2])!=null&&d.pressed&&!this.gamepadButtons.x?(this.handleHold(),this.gamepadButtons.x=!0):(h=u.buttons[2])!=null&&h.pressed||(this.gamepadButtons.x=!1),(I=u.buttons[3])!=null&&I.pressed&&!this.gamepadButtons.y?(this.handleHardDrop(),this.gamepadButtons.y=!0):(S=u.buttons[3])!=null&&S.pressed||(this.gamepadButtons.y=!1),(_=u.buttons[9])!=null&&_.pressed&&!this.gamepadButtons.start?(this.handlePause(),this.gamepadButtons.start=!0):(v=u.buttons[9])!=null&&v.pressed||(this.gamepadButtons.start=!1)}}requestAnimationFrame(()=>this.pollGamepad())}setupMobileButtons(){document.querySelectorAll(".control-btn[data-action]").forEach(t=>{const s=t.getAttribute("data-action");t.addEventListener("touchstart",r=>{r.preventDefault(),r.stopPropagation(),this.handleMobileButtonPress(s),t.classList.add("pressed")},{passive:!1}),t.addEventListener("touchend",r=>{r.preventDefault(),r.stopPropagation(),this.handleMobileButtonRelease(s),t.classList.remove("pressed")},{passive:!1}),t.addEventListener("mousedown",r=>{r.preventDefault(),this.handleMobileButtonPress(s),t.classList.add("pressed")}),t.addEventListener("mouseup",r=>{r.preventDefault(),this.handleMobileButtonRelease(s),t.classList.remove("pressed")}),t.addEventListener("mouseleave",r=>{this.handleMobileButtonRelease(s),t.classList.remove("pressed")})})}handleMobileButtonPress(e){if(e==="pause"){this.handlePause();return}if(!(!this.game.isPlaying||this.game.isPaused))switch(e){case"left":this.handleMoveLeft(),this.startDAS("left");break;case"right":this.handleMoveRight(),this.startDAS("right");break;case"softdrop":this.handleSoftDrop();break;case"harddrop":this.handleHardDrop();break;case"rotate":this.handleRotate();break;case"hold":this.handleHold();break}}handleMobileButtonRelease(e){switch(e){case"left":case"right":this.stopDAS();break;case"softdrop":this.stopSoftDrop();break}}}let c,T=null;function O(){return(T===null||T.byteLength===0)&&(T=new Uint8Array(c.memory.buffer)),T}let N=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&N.decode();const z=2146435072;let B=0;function Y(o,e){return B+=e,B>=z&&(N=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}},N.decode(),B=e),N.decode(O().subarray(o,o+e))}function L(o,e){return o=o>>>0,Y(o,e)}function X(o,e){return o=o>>>0,O().subarray(o/1,o/1+e)}const y=new Array(128).fill(void 0);y.push(void 0,null,!0,!1);let k=y.length;function D(o){k===y.length&&y.push(y.length+1);const e=k;return k=y[e],y[e]=o,e}function G(o,e){try{return o.apply(this,e)}catch(t){c.__wbindgen_export_1(D(t))}}function F(o){return y[o]}let w=0;const A=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},K=typeof A.encodeInto=="function"?function(o,e){return A.encodeInto(o,e)}:function(o,e){const t=A.encode(o);return e.set(t),{read:o.length,written:t.length}};function x(o,e,t){if(t===void 0){const n=A.encode(o),l=e(n.length,1)>>>0;return O().subarray(l,l+n.length).set(n),w=n.length,l}let s=o.length,r=e(s,1)>>>0;const i=O();let a=0;for(;a<s;a++){const n=o.charCodeAt(a);if(n>127)break;i[r+a]=n}if(a!==s){a!==0&&(o=o.slice(a)),r=t(r,s,s=a+o.length*3,1)>>>0;const n=O().subarray(r+a,r+s),l=K(o,n);a+=l.written,r=t(r,s,a,1)>>>0}return w=a,r}let P=null;function f(){return(P===null||P.buffer.detached===!0||P.buffer.detached===void 0&&P.buffer!==c.memory.buffer)&&(P=new DataView(c.memory.buffer)),P}function V(o){o<132||(y[o]=k,k=o)}function p(o){const e=F(o);return V(o),e}const j=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(o=>c.__wbg_jsondb_free(o>>>0,1));class Q{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,j.unregister(this),e}free(){const e=this.__destroy_into_raw();c.__wbg_jsondb_free(e,0)}constructor(){try{const r=c.__wbindgen_add_to_stack_pointer(-16);c.jsondb_new(r);var e=f().getInt32(r+4*0,!0),t=f().getInt32(r+4*1,!0),s=f().getInt32(r+4*2,!0);if(s)throw p(t);return this.__wbg_ptr=e>>>0,j.register(this,this.__wbg_ptr,this),this}finally{c.__wbindgen_add_to_stack_pointer(16)}}insert(e){try{const i=c.__wbindgen_add_to_stack_pointer(-16),a=x(e,c.__wbindgen_export_2,c.__wbindgen_export_3),n=w;c.jsondb_insert(i,this.__wbg_ptr,a,n);var t=f().getInt32(i+4*0,!0),s=f().getInt32(i+4*1,!0),r=f().getInt32(i+4*2,!0);if(r)throw p(s);return p(t)}finally{c.__wbindgen_add_to_stack_pointer(16)}}get(e){try{const i=c.__wbindgen_add_to_stack_pointer(-16),a=x(e,c.__wbindgen_export_2,c.__wbindgen_export_3),n=w;c.jsondb_get(i,this.__wbg_ptr,a,n);var t=f().getInt32(i+4*0,!0),s=f().getInt32(i+4*1,!0),r=f().getInt32(i+4*2,!0);if(r)throw p(s);return p(t)}finally{c.__wbindgen_add_to_stack_pointer(16)}}update(e,t){try{const a=c.__wbindgen_add_to_stack_pointer(-16),n=x(e,c.__wbindgen_export_2,c.__wbindgen_export_3),l=w,d=x(t,c.__wbindgen_export_2,c.__wbindgen_export_3),h=w;c.jsondb_update(a,this.__wbg_ptr,n,l,d,h);var s=f().getInt32(a+4*0,!0),r=f().getInt32(a+4*1,!0),i=f().getInt32(a+4*2,!0);if(i)throw p(r);return p(s)}finally{c.__wbindgen_add_to_stack_pointer(16)}}delete(e){try{const i=c.__wbindgen_add_to_stack_pointer(-16),a=x(e,c.__wbindgen_export_2,c.__wbindgen_export_3),n=w;c.jsondb_delete(i,this.__wbg_ptr,a,n);var t=f().getInt32(i+4*0,!0),s=f().getInt32(i+4*1,!0),r=f().getInt32(i+4*2,!0);if(r)throw p(s);return p(t)}finally{c.__wbindgen_add_to_stack_pointer(16)}}stats(){try{const r=c.__wbindgen_add_to_stack_pointer(-16);c.jsondb_stats(r,this.__wbg_ptr);var e=f().getInt32(r+4*0,!0),t=f().getInt32(r+4*1,!0),s=f().getInt32(r+4*2,!0);if(s)throw p(t);return p(e)}finally{c.__wbindgen_add_to_stack_pointer(16)}}list_ids(){try{const r=c.__wbindgen_add_to_stack_pointer(-16);c.jsondb_list_ids(r,this.__wbg_ptr);var e=f().getInt32(r+4*0,!0),t=f().getInt32(r+4*1,!0),s=f().getInt32(r+4*2,!0);if(s)throw p(t);return p(e)}finally{c.__wbindgen_add_to_stack_pointer(16)}}}const Z=new Set(["basic","cors","default"]);async function ee(o,e){if(typeof Response=="function"&&o instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(o,e)}catch(s){if(o.ok&&Z.has(o.type)&&o.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",s);else throw s}const t=await o.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(o,e);return t instanceof WebAssembly.Instance?{instance:t,module:o}:t}}function te(){const o={};return o.wbg={},o.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let s,r;try{s=e,r=t,console.error(L(e,t))}finally{c.__wbindgen_export_0(s,r,1)}},o.wbg.__wbg_getRandomValues_38a1ff1ea09f6cc7=function(){return G(function(e,t){globalThis.crypto.getRandomValues(X(e,t))},arguments)},o.wbg.__wbg_log_f3c04200b995730f=function(e){console.log(F(e))},o.wbg.__wbg_new_8a6f238a6ece86ea=function(){const e=new Error;return D(e)},o.wbg.__wbg_now_e3057dd824ca0191=function(){return Date.now()},o.wbg.__wbg_parse_0eaa937cfd6388c4=function(){return G(function(e,t){const s=JSON.parse(L(e,t));return D(s)},arguments)},o.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const s=F(t).stack,r=x(s,c.__wbindgen_export_2,c.__wbindgen_export_3),i=w;f().setInt32(e+4*1,i,!0),f().setInt32(e+4*0,r,!0)},o.wbg.__wbg_wbindgenthrow_4c11a24fca429ccf=function(e,t){throw new Error(L(e,t))},o.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,t){const s=L(e,t);return D(s)},o.wbg.__wbindgen_object_drop_ref=function(e){p(e)},o}function se(o,e){return c=o.exports,J.__wbindgen_wasm_module=e,P=null,T=null,c.__wbindgen_start(),c}async function J(o){if(c!==void 0)return c;typeof o<"u"&&(Object.getPrototypeOf(o)===Object.prototype?{module_or_path:o}=o:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof o>"u"&&(o=new URL("/jetrix/assets/jsonic_wasm_bg-CqPUqEIf.wasm",import.meta.url));const e=te();(typeof o=="string"||typeof Request=="function"&&o instanceof Request||typeof URL=="function"&&o instanceof URL)&&(o=fetch(o));const{instance:t,module:s}=await ee(await o,e);return se(t,s)}const re=()=>{const{pathname:o}=window.location;if(o.startsWith("/jetrix/")){const e=document.querySelectorAll('script[src*="assets/"]');return e.length>0?e[0].src.replace(/main-[^.]+\.js$/,"")+"jsonic_wasm_bg-CqPUqEIf.wasm":"/jetrix/assets/jsonic_wasm_bg-CqPUqEIf.wasm"}return"./js/jsonic_wasm_bg.wasm"};let m={wasmUrl:re(),debug:!0,enablePersistence:!0,persistenceKey:"jetrix_highscores"},$=!1,R=null;async function ie(){if(!$)return R||(R=(async()=>{try{m.debug&&console.log("[JSONIC] Attempting to load WASM from:",m.wasmUrl),await J(m.wasmUrl),$=!0,m.debug&&console.log("[JSONIC] ✅ WASM module initialized for Jetrix")}catch(o){console.error("[JSONIC] ❌ Failed to initialize WASM:",o),console.log("[JSONIC] 🔄 Trying alternative WASM URL...");const e=["./js/jsonic_wasm_bg.wasm","/jetrix/js/jsonic_wasm_bg.wasm","../jsonic_wasm_bg.wasm"];for(const t of e)try{m.debug&&console.log("[JSONIC] Trying:",t),await J(t),$=!0,console.log("[JSONIC] ✅ WASM loaded from alternative URL:",t);return}catch(s){m.debug&&console.log("[JSONIC] Failed alternative URL:",t,s.message)}throw new Error("All WASM loading attempts failed")}})()),R}class ae{constructor(e,t={}){this.db=e,this.enablePersistence=t.enablePersistence!==!1,this.persistenceKey=t.persistenceKey||"jetrix_highscores",this.opfsRoot=null,this.initPersistence()}async initPersistence(){if(this.enablePersistence)try{"storage"in navigator&&"getDirectory"in navigator.storage?(this.opfsRoot=await navigator.storage.getDirectory(),console.log("[JSONIC] OPFS persistence enabled for Jetrix"),await this.loadFromOPFS()):console.warn("[JSONIC] OPFS not available, falling back to localStorage")}catch(e){console.error("[JSONIC] Failed to initialize persistence:",e)}}async loadFromOPFS(){var e;try{const r=await(await(await this.opfsRoot.getFileHandle(`${this.persistenceKey}.json`,{create:!1})).getFile()).text(),i=JSON.parse(r);for(const a of i.highscores||[])await this.insertScore(a);console.log(`[JSONIC] Loaded ${((e=i.highscores)==null?void 0:e.length)||0} highscores from OPFS`)}catch(t){t.name!=="NotFoundError"&&console.error("[JSONIC] Failed to load from OPFS:",t)}}async saveToOPFS(){if(this.opfsRoot)try{const e=await this.getAllScores(),s=await(await this.opfsRoot.getFileHandle(`${this.persistenceKey}.json`,{create:!0})).createWritable();await s.write(JSON.stringify({highscores:e,timestamp:Date.now(),version:"1.0.0"})),await s.close(),console.log(`[JSONIC] Saved ${e.length} highscores to OPFS`)}catch(e){console.error("[JSONIC] Failed to save to OPFS:",e)}}async insertScore(e){try{e.id||(e.id=`score_${Date.now()}_${Math.random().toString(36).substr(2,9)}`);const t=await this.db.insert(JSON.stringify(e)),s=typeof t=="string"?JSON.parse(t):t;return m.debug&&(console.log("[JSONIC] Inserted score:",e),console.log("[JSONIC] Returned ID:",s.data)),s.success&&this.enablePersistence&&await this.saveToOPFS(),s.data}catch(t){throw console.error("[JSONIC] Failed to insert score:",t),t}}async getScore(e){try{const t=await this.db.get(e),s=typeof t=="string"?JSON.parse(t):t;if(s.success){const r=s.data;return r&&r.content?r.content:r}return null}catch(t){return console.error("[JSONIC] Failed to get score:",t),null}}async updateScore(e,t){try{const s=await this.db.update(e,JSON.stringify(t)),r=typeof s=="string"?JSON.parse(s):s;return r.success&&this.enablePersistence&&await this.saveToOPFS(),r.success}catch(s){return console.error("[JSONIC] Failed to update score:",s),!1}}async deleteScore(e){try{const t=await this.db.delete(e),s=typeof t=="string"?JSON.parse(t):t;return s.success&&this.enablePersistence&&await this.saveToOPFS(),s.success}catch(t){return console.error("[JSONIC] Failed to delete score:",t),!1}}async getAllScores(){try{m.debug&&console.log("[JSONIC] getAllScores: Getting list of IDs...");const e=await this.db.list_ids(),t=typeof e=="string"?JSON.parse(e):e;m.debug&&(console.log("[JSONIC] getAllScores: Raw IDs result:",e),console.log("[JSONIC] getAllScores: Parsed IDs:",t));const s=[];for(const r of t.data||[]){m.debug&&console.log("[JSONIC] getAllScores: Getting score for ID:",r);const i=await this.getScore(r);m.debug&&console.log("[JSONIC] getAllScores: Retrieved score:",i),i&&s.push({...i,_id:r})}return m.debug&&console.log("[JSONIC] getAllScores: Final scores array:",s),s}catch(e){return console.error("[JSONIC] Failed to get all scores:",e),[]}}async findScores(e={},t={}){m.debug&&console.log("[JSONIC] findScores called with filter:",e,"options:",t);const s=await this.getAllScores();m.debug&&(console.log("[JSONIC] getAllScores returned:",s.length,"scores"),s.length>0&&console.log("[JSONIC] First score example:",s[0]));let r=s;return Object.keys(e).length>0&&(r=s.filter(i=>Object.entries(e).every(([a,n])=>{if(typeof n=="object"&&n!==null){if(n.$gt!==void 0)return i[a]>n.$gt;if(n.$gte!==void 0)return i[a]>=n.$gte;if(n.$lt!==void 0)return i[a]<n.$lt;if(n.$lte!==void 0)return i[a]<=n.$lte;if(n.$eq!==void 0)return i[a]===n.$eq;if(n.$ne!==void 0)return i[a]!==n.$ne;if(n.$in!==void 0)return n.$in.includes(i[a]);if(n.$nin!==void 0)return!n.$nin.includes(i[a])}return i[a]===n}))),t.sort&&r.sort((i,a)=>{for(const[n,l]of Object.entries(t.sort)){const d=i[n],h=a[n];if(d!==h)return l===-1?h>d?1:-1:d>h?1:-1}return 0}),t.skip&&(r=r.slice(t.skip)),t.limit&&(r=r.slice(0,t.limit)),r}async findOneScore(e={}){return(await this.findScores(e,{limit:1}))[0]||null}async countScores(e={}){return(await this.findScores(e)).length}async getStats(){try{const e=await this.db.stats(),t=typeof e=="string"?JSON.parse(e):e,s=await this.getAllScores();return{totalScores:s.length,uniquePlayers:new Set(s.map(r=>r.playerId)).size,gameModes:new Set(s.map(r=>r.gameMode)).size,highestScore:Math.max(...s.map(r=>r.score),0),lastUpdated:Math.max(...s.map(r=>r.timestamp),0),wasmStats:t.data||{}}}catch(e){return console.error("[JSONIC] Failed to get stats:",e),{totalScores:0,uniquePlayers:0,gameModes:0,highestScore:0}}}}const E={version:"1.0.0",configure(o){m={...m,...o},m.debug&&console.log("[JSONIC] Configuration updated for Jetrix:",m)},async createDatabase(o={}){await ie();const e=new Q,t={...m,...o};return new ae(e,t)}};typeof window<"u"&&(window.JSONIC=E,window.JSONIC_READY=Promise.resolve(E),setTimeout(()=>{window.dispatchEvent(new CustomEvent("jsonic-ready",{detail:E}))},0));class ne{constructor(e="https://jsonic1.immudb.io"){this.serverUrl=e,this.apiEndpoint=`${e}/api/v1`,this.database="jetrix",this.collection="highscores",this.ws=null,this.connected=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.syncQueue=[],this.callbacks=new Map,this.requestId=0}async connect(){try{const t=`${this.serverUrl.replace("https://","wss://").replace("http://","ws://")}/ws`;return console.log("[JSONIC Server] Connecting to:",t),this.ws=new WebSocket(t),new Promise((s,r)=>{const i=setTimeout(()=>{r(new Error("Connection timeout"))},1e4);this.ws.onopen=()=>{clearTimeout(i),this.connected=!0,this.reconnectAttempts=0,console.log("[JSONIC Server] ✅ Connected to server"),this.send({type:"init",database:this.database,collection:this.collection}),this.processSyncQueue(),s()},this.ws.onerror=a=>{clearTimeout(i),console.error("[JSONIC Server] Connection error:",a),r(a)},this.ws.onclose=()=>{this.connected=!1,console.log("[JSONIC Server] Disconnected"),this.handleDisconnect()},this.ws.onmessage=a=>{this.handleMessage(a.data)}})}catch(e){return console.error("[JSONIC Server] Failed to connect:",e),this.connected=!1,this.fallbackToHttp()}}send(e){this.connected&&this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):this.syncQueue.push(e)}handleMessage(e){try{const t=JSON.parse(e);if(t.requestId&&this.callbacks.has(t.requestId)){const s=this.callbacks.get(t.requestId);this.callbacks.delete(t.requestId),s(t)}t.type==="update"&&t.collection===this.collection&&this.handleRealtimeUpdate(t.data)}catch(t){console.error("[JSONIC Server] Failed to handle message:",t)}}handleDisconnect(){if(this.reconnectAttempts<this.maxReconnectAttempts){const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts);this.reconnectAttempts++,console.log(`[JSONIC Server] Reconnecting in ${e}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),setTimeout(()=>{this.connect()},e)}else console.log("[JSONIC Server] Max reconnection attempts reached. Falling back to HTTP."),this.fallbackToHttp()}processSyncQueue(){for(;this.syncQueue.length>0&&this.connected;){const e=this.syncQueue.shift();this.send(e)}}async submitScore(e){const t=`req_${++this.requestId}`,s={type:"insert",requestId:t,database:this.database,collection:this.collection,document:{...e,id:`${e.playerId}_${Date.now()}`,timestamp:e.timestamp||Date.now(),serverTime:null}};return this.connected?new Promise((r,i)=>{const a=setTimeout(()=>{this.callbacks.delete(t),i(new Error("Request timeout"))},5e3);this.callbacks.set(t,n=>{clearTimeout(a),n.success?r(n.data):i(new Error(n.error||"Failed to submit score"))}),this.send(s)}):this.submitScoreHttp(e)}async getLeaderboard(e="normal",t=100,s=null){const r=`req_${++this.requestId}`,i={gameMode:e};if(s){const n=this.getTimeCutoff(s);i.timestamp={$gte:n}}const a={type:"query",requestId:r,database:this.database,collection:this.collection,filter:i,options:{sort:{score:-1},limit:t}};return this.connected?new Promise((n,l)=>{const d=setTimeout(()=>{this.callbacks.delete(r),l(new Error("Request timeout"))},5e3);this.callbacks.set(r,h=>{clearTimeout(d),h.success?n(h.data||[]):l(new Error(h.error||"Failed to get leaderboard"))}),this.send(a)}):this.getLeaderboardHttp(e,t,s)}async getPersonalBest(e,t="normal"){const s=`req_${++this.requestId}`,r={type:"query",requestId:s,database:this.database,collection:this.collection,filter:{playerId:e,gameMode:t},options:{sort:{score:-1},limit:1}};return this.connected?new Promise((i,a)=>{const n=setTimeout(()=>{this.callbacks.delete(s),i(null)},5e3);this.callbacks.set(s,l=>{clearTimeout(n),l.success&&l.data&&l.data.length>0?i(l.data[0]):i(null)}),this.send(r)}):this.getPersonalBestHttp(e,t)}async getGlobalStats(){const e=`req_${++this.requestId}`,t={type:"aggregate",requestId:e,database:this.database,collection:this.collection,pipeline:[{$group:{_id:null,totalGames:{$sum:1},uniquePlayers:{$addToSet:"$playerId"},highestScore:{$max:"$score"},totalLines:{$sum:"$lines"}}}]};return this.connected?new Promise((s,r)=>{const i=setTimeout(()=>{this.callbacks.delete(e),s(this.getDefaultStats())},5e3);this.callbacks.set(e,a=>{if(clearTimeout(i),a.success&&a.data&&a.data.length>0){const n=a.data[0];s({totalGames:n.totalGames||0,uniquePlayers:n.uniquePlayers?n.uniquePlayers.length:0,highestScore:n.highestScore||0,totalLines:n.totalLines||0})}else s(this.getDefaultStats())}),this.send(t)}):this.getGlobalStatsHttp()}async fallbackToHttp(){return console.log("[JSONIC Server] Using HTTP API fallback"),this.connected=!1,!0}async submitScoreHttp(e){try{const t=await fetch(`${this.apiEndpoint}/databases/${this.database}/collections/${this.collection}/documents`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}catch(t){throw console.error("[JSONIC Server] HTTP submit failed:",t),t}}async getLeaderboardHttp(e,t,s){try{const r={gameMode:e};s&&(r.timestamp={$gte:this.getTimeCutoff(s)});const i=new URLSearchParams({filter:JSON.stringify(r),sort:JSON.stringify({score:-1}),limit:t.toString()}),a=await fetch(`${this.apiEndpoint}/databases/${this.database}/collections/${this.collection}/documents?${i}`);if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);return(await a.json()).documents||[]}catch(r){return console.error("[JSONIC Server] HTTP get leaderboard failed:",r),[]}}async getPersonalBestHttp(e,t){try{const s=new URLSearchParams({filter:JSON.stringify({playerId:e,gameMode:t}),sort:JSON.stringify({score:-1}),limit:"1"}),r=await fetch(`${this.apiEndpoint}/databases/${this.database}/collections/${this.collection}/documents?${s}`);if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const i=await r.json();return i.documents&&i.documents.length>0?i.documents[0]:null}catch(s){return console.error("[JSONIC Server] HTTP get personal best failed:",s),null}}async getGlobalStatsHttp(){try{const e=await fetch(`${this.apiEndpoint}/databases/${this.database}/collections/${this.collection}/stats`);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return await e.json()}catch(e){return console.error("[JSONIC Server] HTTP get stats failed:",e),this.getDefaultStats()}}getTimeCutoff(e){const t=Date.now();switch(e){case"daily":return t-24*60*60*1e3;case"weekly":return t-7*24*60*60*1e3;case"monthly":return t-30*24*60*60*1e3;default:return 0}}getDefaultStats(){return{totalGames:0,uniquePlayers:0,highestScore:0,totalLines:0}}handleRealtimeUpdate(e){typeof window<"u"&&window.dispatchEvent(new CustomEvent("jsonic-leaderboard-update",{detail:e}))}disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.connected=!1,this.syncQueue=[],this.callbacks.clear()}}class q{constructor(){this.db=null,this.serverClient=null,this.playerId=null,this.leaderboardCache=new Map,this.updateCallbacks=new Set,this.isInitialized=!1,this.serverEnabled=!0}async initialize(){if(!this.isInitialized)try{if(this.playerId=localStorage.getItem("playerId"),this.playerId||(this.playerId=this.generatePlayerId(),localStorage.setItem("playerId",this.playerId)),E.configure({debug:!1,enablePersistence:!0,persistenceKey:"jetrix_highscores"}),this.db=await E.createDatabase(),console.log("✅ JSONIC local database initialized successfully"),this.serverEnabled)try{this.serverClient=new ne("https://jsonic1.immudb.io"),await this.serverClient.connect(),console.log("✅ Connected to JSONIC server for global leaderboard"),window.addEventListener("jsonic-leaderboard-update",e=>{this.handleServerUpdate(e.detail)})}catch(e){console.warn("⚠️ Could not connect to JSONIC server, using local storage only:",e),this.serverClient=null}await this.loadMiniLeaderboard(),this.isInitialized=!0}catch(e){console.error("❌ Failed to initialize JSONIC database:",e),console.log("📦 Falling back to localStorage..."),this.useFallbackStorage(),await this.loadMiniLeaderboard(),this.isInitialized=!0}}generatePlayerId(){return"player_"+Math.random().toString(36).substr(2,9)+Date.now().toString(36)}async submitScore(e){this.isInitialized||await this.initialize();const t={isHighscore:!1,rank:null,personalBest:null,globalRank:null};try{if(!this.db)return this.submitScoreFallback(e);const s=await this.getPersonalBest(e.gameMode);if(t.personalBest=(s==null?void 0:s.score)||0,!s||e.score>s.score){const r={playerId:this.playerId,playerName:e.playerName||"Anonymous",score:e.score,level:e.level,lines:e.lines,gameMode:e.gameMode,timestamp:Date.now(),metadata:e.metadata||{}};if(await this.db.insertScore(r),this.serverClient)try{await this.serverClient.submitScore(r),console.log("🌐 Score synced to global leaderboard");const i=await this.serverClient.getLeaderboard(e.gameMode,1e3);t.globalRank=i.findIndex(a=>a.score<e.score)+1,t.globalRank===0&&(t.globalRank=i.length+1)}catch(i){console.warn("⚠️ Could not sync score to server:",i)}t.rank=await this.getRank(e.score,e.gameMode),t.isHighscore=!0,this.leaderboardCache.clear(),await this.loadMiniLeaderboard(),this.notifySubscribers(),console.log(`🏆 New highscore saved: ${e.score} (Local Rank #${t.rank}, Global Rank #${t.globalRank||"N/A"})`)}}catch(s){return console.error("Failed to submit score to JSONIC:",s),this.submitScoreFallback(e)}return t}async getPersonalBest(e){if(!this.db)return this.getPersonalBestFallback(e);try{return(await this.db.findScores({playerId:this.playerId,gameMode:e},{sort:{score:-1},limit:1}))[0]||null}catch(t){return console.error("Failed to get personal best:",t),this.getPersonalBestFallback(e)}}async getRank(e,t){if(!this.db)return this.getLocalScores().filter(i=>i.gameMode===t&&i.score>e).length+1;try{return await this.db.countScores({gameMode:t,score:{$gt:e}})+1}catch(s){return console.error("Failed to get rank:",s),999}}async getLeaderboard(e="normal",t="all",s=100,r="global"){const i=`${r}-${e}-${t}-${s}`;if(this.leaderboardCache.has(i)){const n=this.leaderboardCache.get(i);if(Date.now()-n.timestamp<3e4)return n.data}let a=[];if(r==="global"&&this.serverClient)try{a=(await this.serverClient.getLeaderboard(e,s,t)).map((l,d)=>({rank:d+1,playerId:l.playerId,playerName:l.playerName,score:l.score,level:l.level,lines:l.lines,timestamp:l.timestamp,isCurrentPlayer:l.playerId===this.playerId,source:"global"})),console.log(`🌐 Loaded ${a.length} scores from global leaderboard`)}catch(n){console.warn("⚠️ Could not load global leaderboard:",n),r="local"}if(r==="local"||a.length===0){if(!this.db)return this.getLeaderboardFallback(e,t,s);try{const n={gameMode:e};t!=="all"&&(n.timestamp={$gte:this.getTimeCutoff(t)}),a=(await this.db.findScores(n,{sort:{score:-1},limit:s})).map((d,h)=>({rank:h+1,playerId:d.playerId,playerName:d.playerName,score:d.score,level:d.level,lines:d.lines,timestamp:d.timestamp,isCurrentPlayer:d.playerId===this.playerId,source:"local"})),console.log(`📱 Loaded ${a.length} scores from local leaderboard`)}catch(n){return console.error("Failed to get leaderboard from JSONIC:",n),this.getLeaderboardFallback(e,t,s)}}return this.leaderboardCache.set(i,{data:a,timestamp:Date.now()}),a}getTimeCutoff(e){const t=Date.now();switch(e){case"daily":return t-24*60*60*1e3;case"weekly":return t-7*24*60*60*1e3;case"monthly":return t-30*24*60*60*1e3;default:return 0}}async loadMiniLeaderboard(){try{const e=await this.getLeaderboard("normal","all",5,"global");this.updateMiniLeaderboard(e)}catch(e){console.error("Failed to load mini leaderboard:",e);try{const t=await this.getLeaderboard("normal","all",5,"local");this.updateMiniLeaderboard(t)}catch(t){console.error("Failed to load local mini leaderboard:",t),this.updateMiniLeaderboard([])}}}updateMiniLeaderboard(e){const t=document.getElementById("miniLeaderboard");if(t){if(e.length===0){t.innerHTML='<div class="no-scores">No scores yet</div>';return}t.innerHTML=e.map(s=>`
            <div class="mini-score-entry ${s.isCurrentPlayer?"current-player":""}">
                <span class="rank">#${s.rank}</span>
                <span class="name">${this.truncateName(s.playerName,10)}</span>
                <span class="score">${s.score.toLocaleString()}</span>
            </div>
        `).join("")}}async displayLeaderboard(){document.getElementById("leaderboardContent")&&(this.setupLeaderboardTabs(),await this.loadLeaderboardContent("normal","all"))}setupLeaderboardTabs(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",async t=>{var i;document.querySelectorAll(".tab-btn").forEach(a=>a.classList.remove("active")),t.target.classList.add("active");const s=t.target.dataset.range,r=((i=document.querySelector(".mode-btn.active"))==null?void 0:i.dataset.mode)||"normal";await this.loadLeaderboardContent(r,s)})}),document.querySelectorAll(".mode-btn").forEach(e=>{e.addEventListener("click",async t=>{var i;document.querySelectorAll(".mode-btn").forEach(a=>a.classList.remove("active")),t.target.classList.add("active");const s=t.target.dataset.mode,r=((i=document.querySelector(".tab-btn.active"))==null?void 0:i.dataset.range)||"all";await this.loadLeaderboardContent(s,r)})})}async loadLeaderboardContent(e,t){var a;const s=document.getElementById("leaderboardContent");if(!s)return;s.innerHTML='<div class="loading">Loading scores...</div>';const i=((a=document.querySelector(".source-btn.active"))==null?void 0:a.dataset.source)==="global"?"global":"local";try{const n=await this.getLeaderboard(e,t,50,i);if(n.length===0){s.innerHTML=`<div class="no-scores">No ${i} scores recorded yet. Be the first!</div>`;return}const l=i==="global"?"🌐 Global":"📱 Local";s.innerHTML=`
                <div class="leaderboard-source">${l} Leaderboard</div>
                <div class="leaderboard-table">
                    <div class="leaderboard-header">
                        <span class="col-rank">RANK</span>
                        <span class="col-name">PLAYER</span>
                        <span class="col-score">SCORE</span>
                        <span class="col-level">LEVEL</span>
                        <span class="col-lines">LINES</span>
                        <span class="col-date">DATE</span>
                    </div>
                    <div class="leaderboard-entries">
                        ${n.map(d=>this.renderLeaderboardEntry(d)).join("")}
                    </div>
                </div>
            `}catch(n){console.error("Failed to load leaderboard content:",n),s.innerHTML='<div class="no-scores">Failed to load leaderboard. Please try again.</div>'}}renderLeaderboardEntry(e){const t=new Date(e.timestamp),s=t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:t.getFullYear()!==new Date().getFullYear()?"numeric":void 0});return`
            <div class="leaderboard-entry ${e.isCurrentPlayer?"current-player":""}">
                <span class="col-rank">
                    ${e.rank<=3?this.getRankMedal(e.rank):""}
                    #${e.rank}
                </span>
                <span class="col-name">${this.truncateName(e.playerName,15)}</span>
                <span class="col-score">${e.score.toLocaleString()}</span>
                <span class="col-level">${e.level}</span>
                <span class="col-lines">${e.lines}</span>
                <span class="col-date">${s}</span>
            </div>
        `}getRankMedal(e){switch(e){case 1:return"🥇";case 2:return"🥈";case 3:return"🥉";default:return""}}truncateName(e,t){return e.length<=t?e:e.substr(0,t-3)+"..."}subscribe(e){return this.updateCallbacks.add(e),()=>this.updateCallbacks.delete(e)}notifySubscribers(){this.updateCallbacks.forEach(e=>e())}async getStats(){if(!this.db){const e=this.getLocalScores();return{totalScores:e.length,uniquePlayers:new Set(e.map(t=>t.playerId)).size,highestScore:Math.max(...e.map(t=>t.score),0)}}try{return await this.db.getStats()}catch(e){return console.error("Failed to get stats:",e),{totalScores:0,uniquePlayers:0,highestScore:0}}}useFallbackStorage(){console.log("📦 Using localStorage fallback for highscores"),this.db=null}submitScoreFallback(e){var r;const t=this.getLocalScores();t.push({...e,playerId:this.playerId,timestamp:Date.now()}),t.sort((i,a)=>a.score-i.score),t.splice(100),localStorage.setItem("jetrix_scores",JSON.stringify(t));const s=t.findIndex(i=>i.playerId===this.playerId&&i.score===e.score)+1;return{isHighscore:s<=100,rank:s,personalBest:((r=this.getPersonalBestFallback(e.gameMode))==null?void 0:r.score)||0}}getPersonalBestFallback(e){const s=this.getLocalScores().filter(r=>r.playerId===this.playerId&&r.gameMode===e);return s.length===0?null:s.reduce((r,i)=>i.score>r.score?i:r)}getLeaderboardFallback(e,t,s){const r=this.getLocalScores(),i=this.getTimeCutoff(t);return r.filter(n=>n.gameMode===e&&n.timestamp>=i).slice(0,s).map((n,l)=>({rank:l+1,playerId:n.playerId,playerName:n.playerName||"Anonymous",score:n.score,level:n.level||1,lines:n.lines||0,timestamp:n.timestamp,isCurrentPlayer:n.playerId===this.playerId}))}getLocalScores(){try{const e=localStorage.getItem("jetrix_scores");return e?JSON.parse(e):[]}catch{return[]}}handleServerUpdate(e){this.leaderboardCache.clear(),e.score&&e.gameMode==="normal"&&this.loadMiniLeaderboard(),this.notifySubscribers(),console.log("📡 Received leaderboard update from server:",e)}async syncWithServer(){if(this.serverClient)try{const e=await this.db.getAllScores();for(const t of e)try{await this.serverClient.submitScore(t)}catch(s){console.warn("Failed to sync score:",t,s)}console.log(`✅ Synced ${e.length} local scores to server`)}catch(e){console.error("Failed to sync with server:",e)}}disconnect(){this.serverClient&&(this.serverClient.disconnect(),this.serverClient=null)}}const M={I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:"#00ffff"},O:{shape:[[1,1],[1,1]],color:"#ffff00"},T:{shape:[[0,1,0],[1,1,1],[0,0,0]],color:"#ff00ff"},S:{shape:[[0,1,1],[1,1,0],[0,0,0]],color:"#00ff00"},Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],color:"#ff0000"},J:{shape:[[1,0,0],[1,1,1],[0,0,0]],color:"#0000ff"},L:{shape:[[0,0,1],[1,1,1],[0,0,0]],color:"#ff8800"}},g={BOARD_WIDTH:10,BOARD_HEIGHT:20,LOCK_DELAY:500,POINTS:{SINGLE:100,DOUBLE:300,TRIPLE:500,TETRIS:800,SOFT_DROP:1,HARD_DROP:2,COMBO_MULTIPLIER:50},DIFFICULTY:{easy:{speed:1e3,levelSpeed:80},normal:{speed:800,levelSpeed:60},hard:{speed:600,levelSpeed:40},extreme:{speed:400,levelSpeed:20}}};class oe{constructor(){this.board=[],this.currentPiece=null,this.nextPieces=[],this.holdPiece=null,this.canHold=!0,this.score=0,this.level=1,this.lines=0,this.combo=0,this.gameMode="normal",this.isPlaying=!1,this.isPaused=!1,this.isGameOver=!1,this.dropTimer=0,this.lockTimer=0,this.bag=[],this.renderer=null,this.controls=null,this.highscores=null,this.playerName="Player",this.stats={piecesPlaced:0,tSpins:0,maxCombo:0,startTime:0,endTime:0}}async initialize(){this.resetBoard(),this.renderer=new U(this),this.renderer.initialize(),this.controls=new W(this),this.controls.initialize(),this.highscores=new q,await this.highscores.initialize(),this.setupUI(),this.showStartModal()}resetBoard(){this.board=Array(g.BOARD_HEIGHT).fill(null).map(()=>Array(g.BOARD_WIDTH).fill(0))}setupUI(){var r,i,a,n,l;const e=document.getElementById("startGame");e==null||e.addEventListener("click",()=>this.startGame()),document.querySelectorAll(".btn-difficulty").forEach(d=>{d.addEventListener("click",h=>{document.querySelectorAll(".btn-difficulty").forEach(I=>I.classList.remove("active")),h.target.classList.add("active"),this.gameMode=h.target.dataset.mode})});const t=document.getElementById("playerName");t==null||t.addEventListener("change",d=>{this.playerName=d.target.value||"Player",localStorage.setItem("playerName",this.playerName)});const s=localStorage.getItem("playerName");s&&t&&(t.value=s,this.playerName=s),(r=document.getElementById("viewHighscores"))==null||r.addEventListener("click",()=>{this.showHighscoresModal()}),(i=document.getElementById("closeHighscores"))==null||i.addEventListener("click",()=>{document.getElementById("highscoreModal").style.display="none"}),(a=document.getElementById("playAgain"))==null||a.addEventListener("click",()=>{this.hideGameOverModal(),this.startGame()}),(n=document.getElementById("mainMenu"))==null||n.addEventListener("click",()=>{this.hideGameOverModal(),this.showStartModal()}),(l=document.getElementById("overlayButton"))==null||l.addEventListener("click",()=>{this.isPaused&&this.resume()})}showStartModal(){document.getElementById("startModal").style.display="flex",document.getElementById("gameOverModal").style.display="none",document.getElementById("highscoreModal").style.display="none"}hideStartModal(){document.getElementById("startModal").style.display="none"}showHighscoresModal(){document.getElementById("highscoreModal").style.display="flex",this.highscores.displayLeaderboard()}showGameOverModal(){const e=document.getElementById("gameOverModal");document.getElementById("finalScore").textContent=this.score.toLocaleString(),document.getElementById("finalLevel").textContent=this.level,document.getElementById("finalLines").textContent=this.lines,e.style.display="flex"}hideGameOverModal(){document.getElementById("gameOverModal").style.display="none"}async startGame(){this.resetBoard(),this.score=0,this.level=1,this.lines=0,this.combo=0,this.isPlaying=!0,this.isPaused=!1,this.isGameOver=!1,this.holdPiece=null,this.canHold=!0,this.bag=[],this.nextPieces=[],this.stats={piecesPlaced:0,tSpins:0,maxCombo:0,startTime:Date.now(),endTime:0},this.hideStartModal(),this.hideGameOverModal(),this.updateDisplay();for(let e=0;e<3;e++)this.nextPieces.push(this.getNextFromBag());this.spawnPiece(),this.gameLoop()}gameLoop(e=0){if(!(!this.isPlaying||this.isGameOver)){if(!this.isPaused){const t=this.getDropSpeed();this.dropTimer+=16.67,this.dropTimer>=t&&(this.dropTimer=0,this.moveDown()?this.lockTimer=0:(this.lockTimer+=t,this.lockTimer>=g.LOCK_DELAY&&this.lockPiece()))}this.renderer.render(),requestAnimationFrame(t=>this.gameLoop(t))}}getDropSpeed(){const e=g.DIFFICULTY[this.gameMode],t=e.speed,s=e.levelSpeed*(this.level-1);return Math.max(50,t-s)}getNextFromBag(){if(this.bag.length===0){this.bag=["I","O","T","S","Z","J","L"];for(let e=this.bag.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this.bag[e],this.bag[t]]=[this.bag[t],this.bag[e]]}}return this.bag.pop()}spawnPiece(){const e=this.nextPieces.shift();this.nextPieces.push(this.getNextFromBag());const t=M[e].shape,s=M[e].color;this.currentPiece={type:e,shape:t,color:s,x:Math.floor((g.BOARD_WIDTH-t[0].length)/2),y:0,rotation:0},this.isValidPosition(this.currentPiece.x,this.currentPiece.y,t)||this.gameOver(),this.canHold=!0,this.dropTimer=0,this.lockTimer=0}isValidPosition(e,t,s){for(let r=0;r<s.length;r++)for(let i=0;i<s[r].length;i++)if(s[r][i]){const a=e+i,n=t+r;if(a<0||a>=g.BOARD_WIDTH||n>=g.BOARD_HEIGHT||n>=0&&this.board[n][a])return!1}return!0}moveLeft(){return!this.currentPiece||this.isPaused?!1:this.isValidPosition(this.currentPiece.x-1,this.currentPiece.y,this.currentPiece.shape)?(this.currentPiece.x--,this.lockTimer=0,!0):!1}moveRight(){return!this.currentPiece||this.isPaused?!1:this.isValidPosition(this.currentPiece.x+1,this.currentPiece.y,this.currentPiece.shape)?(this.currentPiece.x++,this.lockTimer=0,!0):!1}moveDown(){return!this.currentPiece||this.isPaused?!1:this.isValidPosition(this.currentPiece.x,this.currentPiece.y+1,this.currentPiece.shape)?(this.currentPiece.y++,this.score+=g.POINTS.SOFT_DROP,!0):!1}hardDrop(){if(!this.currentPiece||this.isPaused)return;let e=0;for(;this.isValidPosition(this.currentPiece.x,this.currentPiece.y+1,this.currentPiece.shape);)this.currentPiece.y++,e++;this.score+=e*g.POINTS.HARD_DROP,this.lockPiece(),this.playSound("drop")}rotate(e=!0){if(!this.currentPiece||this.isPaused)return!1;const t=this.rotateMatrix(this.currentPiece.shape,e);if(this.isValidPosition(this.currentPiece.x,this.currentPiece.y,t))return this.currentPiece.shape=t,this.currentPiece.rotation=(this.currentPiece.rotation+(e?1:3))%4,this.lockTimer=0,this.checkTSpin(),!0;const s=this.getWallKicks(this.currentPiece.type,this.currentPiece.rotation,e);for(const[r,i]of s)if(this.isValidPosition(this.currentPiece.x+r,this.currentPiece.y+i,t))return this.currentPiece.x+=r,this.currentPiece.y+=i,this.currentPiece.shape=t,this.currentPiece.rotation=(this.currentPiece.rotation+(e?1:3))%4,this.lockTimer=0,this.checkTSpin(),!0;return!1}rotateMatrix(e,t=!0){const s=e.length,r=Array(s).fill(null).map(()=>Array(s).fill(0));for(let i=0;i<s;i++)for(let a=0;a<s;a++)t?r[a][s-1-i]=e[i][a]:r[s-1-a][i]=e[i][a];return r}getWallKicks(e,t,s){return e==="I"?[[-1,0],[2,0],[-1,2],[2,-1]]:e==="O"?[]:[[-1,0],[1,0],[-1,-1],[1,-1],[0,1]]}checkTSpin(){if(this.currentPiece.type!=="T")return!1;const e=[[this.currentPiece.x-1,this.currentPiece.y-1],[this.currentPiece.x+1,this.currentPiece.y-1],[this.currentPiece.x-1,this.currentPiece.y+1],[this.currentPiece.x+1,this.currentPiece.y+1]];let t=0;for(const[s,r]of e)(s<0||s>=g.BOARD_WIDTH||r>=g.BOARD_HEIGHT||r>=0&&this.board[r][s])&&t++;return t>=3?(this.stats.tSpins++,!0):!1}hold(){if(!this.currentPiece||!this.canHold||this.isPaused)return;const e=this.currentPiece.type;if(this.holdPiece){const t=this.holdPiece;this.holdPiece=e;const s=M[t].shape,r=M[t].color;this.currentPiece={type:t,shape:s,color:r,x:Math.floor((g.BOARD_WIDTH-s[0].length)/2),y:0,rotation:0}}else this.holdPiece=e,this.spawnPiece();this.canHold=!1,this.renderer.renderHold()}lockPiece(){if(!this.currentPiece)return;const e=this.currentPiece.shape;for(let s=0;s<e.length;s++)for(let r=0;r<e[s].length;r++)if(e[s][r]){const i=this.currentPiece.y+s,a=this.currentPiece.x+r;i>=0&&(this.board[i][a]=this.currentPiece.color)}this.stats.piecesPlaced++;const t=this.clearLines();t>0?(this.updateScore(t),this.combo++,this.stats.maxCombo=Math.max(this.stats.maxCombo,this.combo)):this.combo=0,this.spawnPiece()}clearLines(){let e=0;for(let t=g.BOARD_HEIGHT-1;t>=0;t--)this.board[t].every(s=>s!==0)&&(this.board.splice(t,1),this.board.unshift(Array(g.BOARD_WIDTH).fill(0)),e++,t++);if(e>0){this.lines+=e;const t=Math.floor(this.lines/10)+1;t>this.level&&(this.level=t,this.playSound("levelUp")),e===4?this.playSound("tetris"):this.playSound("clear"),this.renderer.animateLineClear(e)}return e}updateScore(e){let t=0;switch(e){case 1:t=g.POINTS.SINGLE;break;case 2:t=g.POINTS.DOUBLE;break;case 3:t=g.POINTS.TRIPLE;break;case 4:t=g.POINTS.TETRIS;break}t*=this.level,this.combo>0&&(t+=g.POINTS.COMBO_MULTIPLIER*this.combo),this.score+=t,this.updateDisplay()}updateDisplay(){document.getElementById("score").textContent=this.score.toLocaleString(),document.getElementById("level").textContent=this.level,document.getElementById("lines").textContent=this.lines}pause(){if(!this.isPlaying||this.isGameOver)return;this.isPaused=!0;const e=document.getElementById("gameOverlay");e.style.display="flex",document.getElementById("overlayTitle").textContent="PAUSED",document.getElementById("overlayMessage").textContent="Press SPACE or ESC to continue"}resume(){this.isPaused=!1,document.getElementById("gameOverlay").style.display="none"}async gameOver(){this.isGameOver=!0,this.isPlaying=!1,this.stats.endTime=Date.now(),this.playSound("gameOver");const e=await this.highscores.submitScore({playerName:this.playerName,score:this.score,level:this.level,lines:this.lines,gameMode:this.gameMode,metadata:{piecesPlaced:this.stats.piecesPlaced,tSpins:this.stats.tSpins,maxCombo:this.stats.maxCombo,timeElapsed:this.stats.endTime-this.stats.startTime}});if(e.isHighscore){const t=document.getElementById("highscoreRank"),s=document.getElementById("rankNumber");t.style.display="flex",s.textContent=e.rank}else document.getElementById("highscoreRank").style.display="none";setTimeout(()=>this.showGameOverModal(),1e3)}playSound(e){}getGhostPosition(){if(!this.currentPiece)return null;let e=this.currentPiece.y;for(;this.isValidPosition(this.currentPiece.x,e+1,this.currentPiece.shape);)e++;return{x:this.currentPiece.x,y:e,shape:this.currentPiece.shape,color:this.currentPiece.color}}}window.addEventListener("DOMContentLoaded",async()=>{const o=new oe,e=new q;await o.initialize(),await e.initialize(),window.game=o,window.highscores=e});
