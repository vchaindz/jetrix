(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();class z{constructor(e){this.game=e,this.canvas=null,this.ctx=null,this.nextCanvas=null,this.nextCtx=null,this.holdCanvas=null,this.holdCtx=null,this.cellSize=30,this.animationFrame=0,this.lineClearAnimation=null,this.particles=[]}initialize(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.nextCanvas=document.getElementById("nextCanvas"),this.nextCtx=this.nextCanvas.getContext("2d"),this.holdCanvas=document.getElementById("holdCanvas"),this.holdCtx=this.holdCanvas.getContext("2d"),[this.ctx,this.nextCtx,this.holdCtx].forEach(e=>{e.imageSmoothingEnabled=!1}),this.initParticles()}initParticles(){for(let e=0;e<20;e++)this.particles.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,vx:(Math.random()-.5)*.5,vy:Math.random()*.5+.5,size:Math.random()*2+1,opacity:Math.random()*.5+.1})}render(){this.clearCanvas(),this.drawGrid(),this.drawBoard(),this.drawGhostPiece(),this.drawCurrentPiece(),this.drawParticles(),this.renderNext(),this.renderHold(),this.animationFrame++,this.lineClearAnimation&&this.drawLineClearAnimation()}clearCanvas(){const e=this.ctx.createLinearGradient(0,0,0,this.canvas.height);e.addColorStop(0,"#0a0a0a"),e.addColorStop(1,"#1a0a2a"),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawGrid(){this.ctx.strokeStyle="rgba(255, 255, 255, 0.05)",this.ctx.lineWidth=1;for(let e=0;e<=10;e++)this.ctx.beginPath(),this.ctx.moveTo(e*this.cellSize,0),this.ctx.lineTo(e*this.cellSize,this.canvas.height),this.ctx.stroke();for(let e=0;e<=20;e++)this.ctx.beginPath(),this.ctx.moveTo(0,e*this.cellSize),this.ctx.lineTo(this.canvas.width,e*this.cellSize),this.ctx.stroke()}drawBoard(){const e=this.game.board;for(let t=0;t<e.length;t++)for(let s=0;s<e[t].length;s++)e[t][s]&&this.drawCell(s,t,e[t][s],1)}drawCurrentPiece(){const e=this.game.currentPiece;if(!e)return;const t=e.shape;for(let s=0;s<t.length;s++)for(let r=0;r<t[s].length;r++)t[s][r]&&this.drawCell(e.x+r,e.y+s,e.color,1)}drawGhostPiece(){const e=this.game.getGhostPosition();if(!e)return;const t=e.shape;for(let s=0;s<t.length;s++)for(let r=0;r<t[s].length;r++)t[s][r]&&this.drawCell(e.x+r,e.y+s,e.color,.2)}drawCell(e,t,s,r=1){const i=e*this.cellSize,a=t*this.cellSize,o=this.cellSize,l=1,d=this.ctx.createLinearGradient(i,a,i+o,a+o),g=this.hexToRgb(s);d.addColorStop(0,`rgba(${g.r}, ${g.g}, ${g.b}, ${r})`),d.addColorStop(1,`rgba(${g.r*.6}, ${g.g*.6}, ${g.b*.6}, ${r})`),this.ctx.fillStyle=d,this.ctx.fillRect(i+l,a+l,o-l*2,o-l*2),r>.5&&(this.ctx.shadowColor=s,this.ctx.shadowBlur=10,this.ctx.strokeStyle=s,this.ctx.lineWidth=1,this.ctx.strokeRect(i+l,a+l,o-l*2,o-l*2),this.ctx.shadowBlur=0),this.ctx.strokeStyle=`rgba(255, 255, 255, ${r*.3})`,this.ctx.lineWidth=1,this.ctx.strokeRect(i+l+2,a+l+2,o-l*2-4,o-l*2-4)}renderNext(){const e=this.nextCtx.createLinearGradient(0,0,0,this.nextCanvas.height);e.addColorStop(0,"rgba(10, 10, 10, 0.8)"),e.addColorStop(1,"rgba(26, 10, 42, 0.8)"),this.nextCtx.fillStyle=e,this.nextCtx.fillRect(0,0,this.nextCanvas.width,this.nextCanvas.height);const t=this.game.nextPieces,s={I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:"#00ffff"},O:{shape:[[1,1],[1,1]],color:"#ffff00"},T:{shape:[[0,1,0],[1,1,1],[0,0,0]],color:"#ff00ff"},S:{shape:[[0,1,1],[1,1,0],[0,0,0]],color:"#00ff00"},Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],color:"#ff0000"},J:{shape:[[1,0,0],[1,1,1],[0,0,0]],color:"#0000ff"},L:{shape:[[0,0,1],[1,1,1],[0,0,0]],color:"#ff8800"}};for(let r=0;r<Math.min(3,t.length);r++){const i=s[t[r]];i&&this.drawPiecePreview(this.nextCtx,i.shape,i.color,60,40+r*120,20)}}renderHold(){const e=this.holdCtx.createLinearGradient(0,0,0,this.holdCanvas.height);if(e.addColorStop(0,"rgba(10, 10, 10, 0.8)"),e.addColorStop(1,"rgba(26, 10, 42, 0.8)"),this.holdCtx.fillStyle=e,this.holdCtx.fillRect(0,0,this.holdCanvas.width,this.holdCanvas.height),this.game.holdPiece){const s={I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:"#00ffff"},O:{shape:[[1,1],[1,1]],color:"#ffff00"},T:{shape:[[0,1,0],[1,1,1],[0,0,0]],color:"#ff00ff"},S:{shape:[[0,1,1],[1,1,0],[0,0,0]],color:"#00ff00"},Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],color:"#ff0000"},J:{shape:[[1,0,0],[1,1,1],[0,0,0]],color:"#0000ff"},L:{shape:[[0,0,1],[1,1,1],[0,0,0]],color:"#ff8800"}}[this.game.holdPiece];if(s){const r=this.game.canHold?1:.3;this.drawPiecePreview(this.holdCtx,s.shape,s.color,60,60,20,r)}}}drawPiecePreview(e,t,s,r,i,a,o=1){const l=t[0].length,d=t.length,g=r-l*a/2,I=i-d*a/2;for(let S=0;S<d;S++)for(let v=0;v<l;v++)if(t[S][v]){const _=g+v*a,h=I+S*a,x=e.createLinearGradient(_,h,_+a,h+a),b=this.hexToRgb(s);x.addColorStop(0,`rgba(${b.r}, ${b.g}, ${b.b}, ${o})`),x.addColorStop(1,`rgba(${b.r*.6}, ${b.g*.6}, ${b.b*.6}, ${o})`),e.fillStyle=x,e.fillRect(_+1,h+1,a-2,a-2),e.strokeStyle=`rgba(255, 255, 255, ${o*.3})`,e.lineWidth=1,e.strokeRect(_+1,h+1,a-2,a-2)}}drawParticles(){this.ctx.save();for(let e of this.particles)e.x+=e.vx,e.y+=e.vy,e.y>this.canvas.height&&(e.y=-10,e.x=Math.random()*this.canvas.width),e.x<0&&(e.x=this.canvas.width),e.x>this.canvas.width&&(e.x=0),this.ctx.fillStyle=`rgba(255, 255, 255, ${e.opacity})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.fill();this.ctx.restore()}animateLineClear(e){this.lineClearAnimation={lines:e,frame:0,maxFrames:30}}drawLineClearAnimation(){const e=this.lineClearAnimation,t=e.frame/e.maxFrames;if(e.frame<10&&(this.ctx.fillStyle=`rgba(255, 255, 255, ${.3*(1-t*3)})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)),e.frame===0)for(let s=0;s<e.lines*10;s++)this.particles.push({x:Math.random()*this.canvas.width,y:this.canvas.height*.7,vx:(Math.random()-.5)*5,vy:-Math.random()*5-2,size:Math.random()*3+2,opacity:1,lifetime:30});e.frame++,e.frame>=e.maxFrames&&(this.lineClearAnimation=null),this.particles=this.particles.filter(s=>!s.lifetime||--s.lifetime>0)}hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:255,g:255,b:255}}}class U{constructor(e){this.game=e,this.keys={},this.keyTimers={},this.dasTimer=null,this.arrTimer=null,this.touchStartX=null,this.touchStartY=null,this.touchStartTime=null}initialize(){this.setupKeyboardControls(),this.setupTouchControls(),this.setupGamepadControls()}setupKeyboardControls(){document.addEventListener("keydown",e=>this.handleKeyDown(e)),document.addEventListener("keyup",e=>this.handleKeyUp(e))}handleKeyDown(e){if(["ArrowLeft","ArrowRight","ArrowDown","ArrowUp"," ","c","C","Escape"].includes(e.key)&&e.preventDefault(),!this.keys[e.key])switch(this.keys[e.key]=!0,e.key){case"ArrowLeft":this.handleMoveLeft(),this.startDAS("left");break;case"ArrowRight":this.handleMoveRight(),this.startDAS("right");break;case"ArrowDown":this.handleSoftDrop();break;case"ArrowUp":this.handleRotate();break;case"z":case"Z":this.handleRotate(!1);break;case" ":this.handleHardDrop();break;case"c":case"C":this.handleHold();break;case"Escape":this.handlePause();break;case"Enter":this.game.isGameOver&&this.game.startGame();break}}handleKeyUp(e){delete this.keys[e.key],(e.key==="ArrowLeft"||e.key==="ArrowRight")&&this.stopDAS(),e.key==="ArrowDown"&&this.stopSoftDrop()}handleMoveLeft(){!this.game.isPlaying||this.game.isPaused||(this.game.moveLeft(),this.game.playSound("move"))}handleMoveRight(){!this.game.isPlaying||this.game.isPaused||(this.game.moveRight(),this.game.playSound("move"))}handleRotate(e=!0){!this.game.isPlaying||this.game.isPaused||this.game.rotate(e)&&this.game.playSound("rotate")}handleSoftDrop(){!this.game.isPlaying||this.game.isPaused||(this.game.moveDown(),this.keyTimers.softDrop||(this.keyTimers.softDrop=setInterval(()=>{this.keys.ArrowDown&&!this.game.isPaused&&this.game.moveDown()},50)))}stopSoftDrop(){this.keyTimers.softDrop&&(clearInterval(this.keyTimers.softDrop),this.keyTimers.softDrop=null)}handleHardDrop(){!this.game.isPlaying||this.game.isPaused||this.game.hardDrop()}handleHold(){!this.game.isPlaying||this.game.isPaused||(this.game.hold(),this.game.playSound("move"))}handlePause(){this.game.isPlaying&&(this.game.isPaused?this.game.resume():this.game.pause())}startDAS(e){this.stopDAS(),this.dasTimer=setTimeout(()=>{this.arrTimer=setInterval(()=>{this.game.isPaused||(e==="left"&&this.keys.ArrowLeft?this.game.moveLeft():e==="right"&&this.keys.ArrowRight?this.game.moveRight():this.stopDAS())},30)},150)}stopDAS(){this.dasTimer&&(clearTimeout(this.dasTimer),this.dasTimer=null),this.arrTimer&&(clearInterval(this.arrTimer),this.arrTimer=null)}setupTouchControls(){const e=document.getElementById("gameCanvas");e.addEventListener("touchstart",t=>this.handleTouchStart(t),{passive:!1}),e.addEventListener("touchmove",t=>this.handleTouchMove(t),{passive:!1}),e.addEventListener("touchend",t=>this.handleTouchEnd(t),{passive:!1}),this.setupMobileButtons()}handleTouchStart(e){e.preventDefault();const t=e.touches[0];this.touchStartX=t.clientX,this.touchStartY=t.clientY,this.touchStartTime=Date.now()}handleTouchMove(e){if(e.preventDefault(),!this.touchStartX||!this.touchStartY)return;const t=e.touches[0],s=t.clientX-this.touchStartX,r=t.clientY-this.touchStartY,i=25;Math.abs(s)>i&&Math.abs(s)>Math.abs(r)&&(s>0?this.handleMoveRight():this.handleMoveLeft(),this.touchStartX=t.clientX),r>i&&Math.abs(r)>Math.abs(s)&&(this.handleSoftDrop(),this.touchStartY=t.clientY)}handleTouchEnd(e){if(e.preventDefault(),!this.touchStartTime)return;const t=Date.now()-this.touchStartTime,s=e.changedTouches[0],r=Math.abs(s.clientX-this.touchStartX),i=Math.abs(s.clientY-this.touchStartY);t<250&&r<15&&i<15&&this.handleRotate(),t<300&&i>40&&s.clientY-this.touchStartY<-40&&this.handleHardDrop(),this.touchStartX=null,this.touchStartY=null,this.touchStartTime=null,this.stopSoftDrop()}setupGamepadControls(){this.gamepadIndex=null,this.gamepadButtons={},window.addEventListener("gamepadconnected",e=>{console.log("Gamepad connected:",e.gamepad.id),this.gamepadIndex=e.gamepad.index}),window.addEventListener("gamepaddisconnected",e=>{console.log("Gamepad disconnected:",e.gamepad.id),this.gamepadIndex===e.gamepad.index&&(this.gamepadIndex=null)}),this.pollGamepad()}pollGamepad(){var e,t,s,r,i,a,o,l,d,g,I,S,v,_;if(this.gamepadIndex!==null){const h=navigator.getGamepads()[this.gamepadIndex];if(h){const x=((e=h.buttons[14])==null?void 0:e.pressed)||h.axes[0]<-.5,b=((t=h.buttons[15])==null?void 0:t.pressed)||h.axes[0]>.5,$=((s=h.buttons[13])==null?void 0:s.pressed)||h.axes[1]>.5;(r=h.buttons[12])!=null&&r.pressed||h.axes[1]<-.5,x&&!this.gamepadButtons.left?(this.handleMoveLeft(),this.gamepadButtons.left=!0):x||(this.gamepadButtons.left=!1),b&&!this.gamepadButtons.right?(this.handleMoveRight(),this.gamepadButtons.right=!0):b||(this.gamepadButtons.right=!1),$&&!this.gamepadButtons.down?(this.handleSoftDrop(),this.gamepadButtons.down=!0):$||(this.gamepadButtons.down=!1,this.stopSoftDrop()),(i=h.buttons[0])!=null&&i.pressed&&!this.gamepadButtons.a?(this.handleRotate(),this.gamepadButtons.a=!0):(a=h.buttons[0])!=null&&a.pressed||(this.gamepadButtons.a=!1),(o=h.buttons[1])!=null&&o.pressed&&!this.gamepadButtons.b?(this.handleRotate(!1),this.gamepadButtons.b=!0):(l=h.buttons[1])!=null&&l.pressed||(this.gamepadButtons.b=!1),(d=h.buttons[2])!=null&&d.pressed&&!this.gamepadButtons.x?(this.handleHold(),this.gamepadButtons.x=!0):(g=h.buttons[2])!=null&&g.pressed||(this.gamepadButtons.x=!1),(I=h.buttons[3])!=null&&I.pressed&&!this.gamepadButtons.y?(this.handleHardDrop(),this.gamepadButtons.y=!0):(S=h.buttons[3])!=null&&S.pressed||(this.gamepadButtons.y=!1),(v=h.buttons[9])!=null&&v.pressed&&!this.gamepadButtons.start?(this.handlePause(),this.gamepadButtons.start=!0):(_=h.buttons[9])!=null&&_.pressed||(this.gamepadButtons.start=!1)}}requestAnimationFrame(()=>this.pollGamepad())}setupMobileButtons(){document.querySelectorAll(".control-btn[data-action]").forEach(t=>{const s=t.getAttribute("data-action");t.addEventListener("touchstart",r=>{r.preventDefault(),r.stopPropagation(),this.handleMobileButtonPress(s),t.classList.add("pressed")},{passive:!1}),t.addEventListener("touchend",r=>{r.preventDefault(),r.stopPropagation(),this.handleMobileButtonRelease(s),t.classList.remove("pressed")},{passive:!1}),t.addEventListener("mousedown",r=>{r.preventDefault(),this.handleMobileButtonPress(s),t.classList.add("pressed")}),t.addEventListener("mouseup",r=>{r.preventDefault(),this.handleMobileButtonRelease(s),t.classList.remove("pressed")}),t.addEventListener("mouseleave",r=>{this.handleMobileButtonRelease(s),t.classList.remove("pressed")})})}handleMobileButtonPress(e){if(e==="pause"){this.handlePause();return}if(!(!this.game.isPlaying||this.game.isPaused))switch(e){case"left":this.handleMoveLeft(),this.startDAS("left");break;case"right":this.handleMoveRight(),this.startDAS("right");break;case"softdrop":this.handleSoftDrop();break;case"harddrop":this.handleHardDrop();break;case"rotate":this.handleRotate();break;case"hold":this.handleHold();break}}handleMobileButtonRelease(e){switch(e){case"left":case"right":this.stopDAS();break;case"softdrop":this.stopSoftDrop();break}}}let c,O=null;function L(){return(O===null||O.byteLength===0)&&(O=new Uint8Array(c.memory.buffer)),O}let N=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&N.decode();const W=2146435072;let R=0;function Y(n,e){return R+=e,R>=W&&(N=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}},N.decode(),R=e),N.decode(L().subarray(n,n+e))}function E(n,e){return n=n>>>0,Y(n,e)}function X(n,e){return n=n>>>0,L().subarray(n/1,n/1+e)}const y=new Array(128).fill(void 0);y.push(void 0,null,!0,!1);let k=y.length;function D(n){k===y.length&&y.push(y.length+1);const e=k;return k=y[e],y[e]=n,e}function J(n,e){try{return n.apply(this,e)}catch(t){c.__wbindgen_export_1(D(t))}}function F(n){return y[n]}let w=0;const A=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},K=typeof A.encodeInto=="function"?function(n,e){return A.encodeInto(n,e)}:function(n,e){const t=A.encode(n);return e.set(t),{read:n.length,written:t.length}};function C(n,e,t){if(t===void 0){const o=A.encode(n),l=e(o.length,1)>>>0;return L().subarray(l,l+o.length).set(o),w=o.length,l}let s=n.length,r=e(s,1)>>>0;const i=L();let a=0;for(;a<s;a++){const o=n.charCodeAt(a);if(o>127)break;i[r+a]=o}if(a!==s){a!==0&&(n=n.slice(a)),r=t(r,s,s=a+n.length*3,1)>>>0;const o=L().subarray(r+a,r+s),l=K(n,o);a+=l.written,r=t(r,s,a,1)>>>0}return w=a,r}let P=null;function u(){return(P===null||P.buffer.detached===!0||P.buffer.detached===void 0&&P.buffer!==c.memory.buffer)&&(P=new DataView(c.memory.buffer)),P}function V(n){n<132||(y[n]=k,k=n)}function p(n){const e=F(n);return V(n),e}const H=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>c.__wbg_jsondb_free(n>>>0,1));class Z{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,H.unregister(this),e}free(){const e=this.__destroy_into_raw();c.__wbg_jsondb_free(e,0)}constructor(){try{const r=c.__wbindgen_add_to_stack_pointer(-16);c.jsondb_new(r);var e=u().getInt32(r+4*0,!0),t=u().getInt32(r+4*1,!0),s=u().getInt32(r+4*2,!0);if(s)throw p(t);return this.__wbg_ptr=e>>>0,H.register(this,this.__wbg_ptr,this),this}finally{c.__wbindgen_add_to_stack_pointer(16)}}insert(e){try{const i=c.__wbindgen_add_to_stack_pointer(-16),a=C(e,c.__wbindgen_export_2,c.__wbindgen_export_3),o=w;c.jsondb_insert(i,this.__wbg_ptr,a,o);var t=u().getInt32(i+4*0,!0),s=u().getInt32(i+4*1,!0),r=u().getInt32(i+4*2,!0);if(r)throw p(s);return p(t)}finally{c.__wbindgen_add_to_stack_pointer(16)}}get(e){try{const i=c.__wbindgen_add_to_stack_pointer(-16),a=C(e,c.__wbindgen_export_2,c.__wbindgen_export_3),o=w;c.jsondb_get(i,this.__wbg_ptr,a,o);var t=u().getInt32(i+4*0,!0),s=u().getInt32(i+4*1,!0),r=u().getInt32(i+4*2,!0);if(r)throw p(s);return p(t)}finally{c.__wbindgen_add_to_stack_pointer(16)}}update(e,t){try{const a=c.__wbindgen_add_to_stack_pointer(-16),o=C(e,c.__wbindgen_export_2,c.__wbindgen_export_3),l=w,d=C(t,c.__wbindgen_export_2,c.__wbindgen_export_3),g=w;c.jsondb_update(a,this.__wbg_ptr,o,l,d,g);var s=u().getInt32(a+4*0,!0),r=u().getInt32(a+4*1,!0),i=u().getInt32(a+4*2,!0);if(i)throw p(r);return p(s)}finally{c.__wbindgen_add_to_stack_pointer(16)}}delete(e){try{const i=c.__wbindgen_add_to_stack_pointer(-16),a=C(e,c.__wbindgen_export_2,c.__wbindgen_export_3),o=w;c.jsondb_delete(i,this.__wbg_ptr,a,o);var t=u().getInt32(i+4*0,!0),s=u().getInt32(i+4*1,!0),r=u().getInt32(i+4*2,!0);if(r)throw p(s);return p(t)}finally{c.__wbindgen_add_to_stack_pointer(16)}}stats(){try{const r=c.__wbindgen_add_to_stack_pointer(-16);c.jsondb_stats(r,this.__wbg_ptr);var e=u().getInt32(r+4*0,!0),t=u().getInt32(r+4*1,!0),s=u().getInt32(r+4*2,!0);if(s)throw p(t);return p(e)}finally{c.__wbindgen_add_to_stack_pointer(16)}}list_ids(){try{const r=c.__wbindgen_add_to_stack_pointer(-16);c.jsondb_list_ids(r,this.__wbg_ptr);var e=u().getInt32(r+4*0,!0),t=u().getInt32(r+4*1,!0),s=u().getInt32(r+4*2,!0);if(s)throw p(t);return p(e)}finally{c.__wbindgen_add_to_stack_pointer(16)}}}const Q=new Set(["basic","cors","default"]);async function ee(n,e){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,e)}catch(s){if(n.ok&&Q.has(n.type)&&n.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",s);else throw s}const t=await n.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(n,e);return t instanceof WebAssembly.Instance?{instance:t,module:n}:t}}function te(){const n={};return n.wbg={},n.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let s,r;try{s=e,r=t,console.error(E(e,t))}finally{c.__wbindgen_export_0(s,r,1)}},n.wbg.__wbg_getRandomValues_38a1ff1ea09f6cc7=function(){return J(function(e,t){globalThis.crypto.getRandomValues(X(e,t))},arguments)},n.wbg.__wbg_log_f3c04200b995730f=function(e){console.log(F(e))},n.wbg.__wbg_new_8a6f238a6ece86ea=function(){const e=new Error;return D(e)},n.wbg.__wbg_now_e3057dd824ca0191=function(){return Date.now()},n.wbg.__wbg_parse_0eaa937cfd6388c4=function(){return J(function(e,t){const s=JSON.parse(E(e,t));return D(s)},arguments)},n.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const s=F(t).stack,r=C(s,c.__wbindgen_export_2,c.__wbindgen_export_3),i=w;u().setInt32(e+4*1,i,!0),u().setInt32(e+4*0,r,!0)},n.wbg.__wbg_wbindgenthrow_4c11a24fca429ccf=function(e,t){throw new Error(E(e,t))},n.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,t){const s=E(e,t);return D(s)},n.wbg.__wbindgen_object_drop_ref=function(e){p(e)},n}function se(n,e){return c=n.exports,q.__wbindgen_wasm_module=e,P=null,O=null,c.__wbindgen_start(),c}async function q(n){if(c!==void 0)return c;typeof n<"u"&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof n>"u"&&(n=new URL("/jetrix/assets/jsonic_wasm_bg-CqPUqEIf.wasm",import.meta.url));const e=te();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:t,module:s}=await ee(await n,e);return se(t,s)}let m={wasmUrl:null,debug:!0,enablePersistence:!0,persistenceKey:"jetrix_highscores"},G=!1,B=null;async function re(){if(!G)return B||(B=(async()=>{try{m.debug&&console.log("[JSONIC] Using auto-detected WASM (bundled by Vite)"),await q(),G=!0,m.debug&&console.log("[JSONIC] ✅ WASM module initialized for Jetrix")}catch(n){throw console.error("[JSONIC] ❌ Failed to initialize WASM:",n),new Error("Failed to initialize WASM module.")}})()),B}class ie{constructor(e,t={}){this.db=e,this.enablePersistence=t.enablePersistence!==!1,this.persistenceKey=t.persistenceKey||"jetrix_highscores",this.opfsRoot=null,this.initPersistence()}async initPersistence(){if(this.enablePersistence)try{"storage"in navigator&&"getDirectory"in navigator.storage?(this.opfsRoot=await navigator.storage.getDirectory(),console.log("[JSONIC] OPFS persistence enabled for Jetrix"),await this.loadFromOPFS()):console.warn("[JSONIC] OPFS not available, falling back to localStorage")}catch(e){console.error("[JSONIC] Failed to initialize persistence:",e)}}async loadFromOPFS(){var e;try{const r=await(await(await this.opfsRoot.getFileHandle(`${this.persistenceKey}.json`,{create:!1})).getFile()).text(),i=JSON.parse(r);for(const a of i.highscores||[])await this.insertScore(a);console.log(`[JSONIC] Loaded ${((e=i.highscores)==null?void 0:e.length)||0} highscores from OPFS`)}catch(t){t.name!=="NotFoundError"&&console.error("[JSONIC] Failed to load from OPFS:",t)}}async saveToOPFS(){if(this.opfsRoot)try{const e=await this.getAllScores(),s=await(await this.opfsRoot.getFileHandle(`${this.persistenceKey}.json`,{create:!0})).createWritable();await s.write(JSON.stringify({highscores:e,timestamp:Date.now(),version:"1.0.0"})),await s.close(),console.log(`[JSONIC] Saved ${e.length} highscores to OPFS`)}catch(e){console.error("[JSONIC] Failed to save to OPFS:",e)}}async insertScore(e){try{e.id||(e.id=`score_${Date.now()}_${Math.random().toString(36).substr(2,9)}`);const t=await this.db.insert(JSON.stringify(e)),s=typeof t=="string"?JSON.parse(t):t;return m.debug&&(console.log("[JSONIC] Inserted score:",e),console.log("[JSONIC] Returned ID:",s.data)),s.success&&this.enablePersistence&&await this.saveToOPFS(),s.data}catch(t){throw console.error("[JSONIC] Failed to insert score:",t),t}}async getScore(e){try{const t=await this.db.get(e),s=typeof t=="string"?JSON.parse(t):t;if(s.success){const r=s.data;return r&&r.content?r.content:r}return null}catch(t){return console.error("[JSONIC] Failed to get score:",t),null}}async updateScore(e,t){try{const s=await this.db.update(e,JSON.stringify(t)),r=typeof s=="string"?JSON.parse(s):s;return r.success&&this.enablePersistence&&await this.saveToOPFS(),r.success}catch(s){return console.error("[JSONIC] Failed to update score:",s),!1}}async deleteScore(e){try{const t=await this.db.delete(e),s=typeof t=="string"?JSON.parse(t):t;return s.success&&this.enablePersistence&&await this.saveToOPFS(),s.success}catch(t){return console.error("[JSONIC] Failed to delete score:",t),!1}}async getAllScores(){try{m.debug&&console.log("[JSONIC] getAllScores: Getting list of IDs...");const e=await this.db.list_ids(),t=typeof e=="string"?JSON.parse(e):e;m.debug&&(console.log("[JSONIC] getAllScores: Raw IDs result:",e),console.log("[JSONIC] getAllScores: Parsed IDs:",t));const s=[];for(const r of t.data||[]){m.debug&&console.log("[JSONIC] getAllScores: Getting score for ID:",r);const i=await this.getScore(r);m.debug&&console.log("[JSONIC] getAllScores: Retrieved score:",i),i&&s.push({...i,_id:r})}return m.debug&&console.log("[JSONIC] getAllScores: Final scores array:",s),s}catch(e){return console.error("[JSONIC] Failed to get all scores:",e),[]}}async findScores(e={},t={}){m.debug&&console.log("[JSONIC] findScores called with filter:",e,"options:",t);const s=await this.getAllScores();m.debug&&(console.log("[JSONIC] getAllScores returned:",s.length,"scores"),s.length>0&&console.log("[JSONIC] First score example:",s[0]));let r=s;return Object.keys(e).length>0&&(r=s.filter(i=>Object.entries(e).every(([a,o])=>{if(typeof o=="object"&&o!==null){if(o.$gt!==void 0)return i[a]>o.$gt;if(o.$gte!==void 0)return i[a]>=o.$gte;if(o.$lt!==void 0)return i[a]<o.$lt;if(o.$lte!==void 0)return i[a]<=o.$lte;if(o.$eq!==void 0)return i[a]===o.$eq;if(o.$ne!==void 0)return i[a]!==o.$ne;if(o.$in!==void 0)return o.$in.includes(i[a]);if(o.$nin!==void 0)return!o.$nin.includes(i[a])}return i[a]===o}))),t.sort&&r.sort((i,a)=>{for(const[o,l]of Object.entries(t.sort)){const d=i[o],g=a[o];if(d!==g)return l===-1?g>d?1:-1:d>g?1:-1}return 0}),t.skip&&(r=r.slice(t.skip)),t.limit&&(r=r.slice(0,t.limit)),r}async findOneScore(e={}){return(await this.findScores(e,{limit:1}))[0]||null}async countScores(e={}){return(await this.findScores(e)).length}async getStats(){try{const e=await this.db.stats(),t=typeof e=="string"?JSON.parse(e):e,s=await this.getAllScores();return{totalScores:s.length,uniquePlayers:new Set(s.map(r=>r.playerId)).size,gameModes:new Set(s.map(r=>r.gameMode)).size,highestScore:Math.max(...s.map(r=>r.score),0),lastUpdated:Math.max(...s.map(r=>r.timestamp),0),wasmStats:t.data||{}}}catch(e){return console.error("[JSONIC] Failed to get stats:",e),{totalScores:0,uniquePlayers:0,gameModes:0,highestScore:0}}}}const T={version:"1.0.0",configure(n){m={...m,...n},m.debug&&console.log("[JSONIC] Configuration updated for Jetrix:",m)},async createDatabase(n={}){await re();const e=new Z,t={...m,...n};return new ie(e,t)}};typeof window<"u"&&(window.JSONIC=T,window.JSONIC_READY=Promise.resolve(T),setTimeout(()=>{window.dispatchEvent(new CustomEvent("jsonic-ready",{detail:T}))},0));class ae{constructor(e={}){this.serverUrl=e.url||"https://jsonic1.immudb.io",this.database=e.database||"jetrix",this.ws=null,this.connected=!1,this.requestId=0,this.callbacks=new Map,this.reconnectAttempts=0,this.maxReconnectAttempts=5}async connect(){var s;if(((s=this.ws)==null?void 0:s.readyState)===WebSocket.OPEN)return;const t=`${this.serverUrl.replace("https://","wss://").replace("http://","ws://")}/api/v1/ws`;return new Promise((r,i)=>{try{console.log("🔌 Connecting to JSONIC server:",t),this.ws=new WebSocket(t),this.ws.onopen=()=>{console.log("✅ Connected to JSONIC server!"),this.connected=!0,this.reconnectAttempts=0,r()},this.ws.onmessage=a=>{try{const o=JSON.parse(a.data);this.handleMessage(o)}catch(o){console.error("Failed to parse server message:",o)}},this.ws.onerror=a=>{console.error("❌ JSONIC server error:",a),i(a)},this.ws.onclose=a=>{if(console.log("🔌 Disconnected from JSONIC server"),this.connected=!1,this.reconnectAttempts<this.maxReconnectAttempts){const o=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);this.reconnectAttempts++,console.log(`🔄 Reconnecting in ${o}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>this.connect(),o)}}}catch(a){i(a)}})}async disconnect(){this.ws&&(this.ws.close(),this.ws=null,this.connected=!1,console.log("🔌 Disconnected from JSONIC server"))}handleMessage(e){if(e.requestId&&this.callbacks.has(e.requestId)){const t=this.callbacks.get(e.requestId);this.callbacks.delete(e.requestId),t(e)}}async sendRequest(e,t,s={}){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("Not connected to server");const r=`req_${++this.requestId}`,i={type:e,database:this.database,collection:t,requestId:r,...s};return new Promise((a,o)=>{const l=setTimeout(()=>{this.callbacks.delete(r),o(new Error("Request timeout"))},1e4);this.callbacks.set(r,d=>{clearTimeout(l),d.success?a(d.data):o(new Error(d.error||"Request failed"))}),console.log("📤 Sending WebSocket request:",i),this.ws.send(JSON.stringify(i))})}async submitScore(e){try{const t=await this.sendRequest("insert","highscores",{document:{...e,timestamp:Date.now()}});return console.log("🌐 ✅ Score successfully saved to global JSONIC server!"),console.log("📊 Server response:",t),console.log("🎯 Your score is now part of the global leaderboard database"),{success:!0,id:t.id||t.insertedId}}catch(t){return console.error("❌ Failed to submit score to server:",t),console.log("📱 Score will be saved locally only"),{success:!1,error:t.message}}}async getLeaderboard(e="normal",t={}){const{limit:s=100,timeRange:r=null}=t;try{const i={gameMode:e};if(r&&r!=="all"){const l=this.getTimeCutoff(r);i.timestamp={$gte:l}}const a=await this.sendRequest("query","highscores",{filter:i,sort:{score:-1},limit:s});console.log("📥 Raw server response:",JSON.stringify(a,null,2));const o=a.map((l,d)=>({rank:d+1,...l}));return console.log(`📊 Fetched ${o.length} scores from server`),o}catch(i){return console.warn("⚠️ Server query issue (known limitation):",i.message),console.log("📋 Note: Scores are still being saved to global server, but leaderboard display uses local data"),[]}}async getPersonalBest(e,t="normal"){try{return(await this.sendRequest("query","highscores",{filter:{playerId:e,gameMode:t},sort:{score:-1},limit:1}))[0]||null}catch(s){return console.warn("⚠️ Server query issue (known limitation):",s.message),console.log("📋 Using local data for personal best calculation"),null}}getTimeCutoff(e){const t=Date.now();switch(e){case"daily":return t-24*60*60*1e3;case"weekly":return t-7*24*60*60*1e3;case"monthly":return t-30*24*60*60*1e3;default:return 0}}get state(){return{connected:this.connected,pendingChanges:0}}}class oe extends ae{constructor(e="https://jsonic1.immudb.io"){super({url:e,database:"jetrix"})}async submitHighscore(e){return this.submitScore(e)}async getHighscores(e=50){return this.getLeaderboard("normal",{limit:e})}watchLeaderboard(e){console.log("📡 Watching leaderboard updates...")}}class j{constructor(){this.db=null,this.serverClient=null,this.playerId=null,this.leaderboardCache=new Map,this.updateCallbacks=new Set,this.isInitialized=!1,this.serverEnabled=!0}async initialize(){if(!this.isInitialized){console.log("🎮 Starting Highscore System Initialization..."),console.log("📱 User Agent:",navigator.userAgent),console.log("📱 Platform:",navigator.platform),console.log("📱 Mobile Device:",/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)),console.log("📄 DOM Ready State:",document.readyState);try{if(this.playerId=localStorage.getItem("playerId"),this.playerId||(this.playerId=this.generatePlayerId(),localStorage.setItem("playerId",this.playerId)),T.configure({debug:!1,enablePersistence:!0,persistenceKey:"jetrix_highscores"}),this.db=await T.createDatabase(),console.log("✅ JSONIC local database initialized successfully"),this.serverEnabled)try{this.serverClient=new oe("https://jsonic1.immudb.io"),await this.serverClient.connect(),console.log("✅ Connected to JSONIC server for global leaderboard"),window.addEventListener("jsonic-leaderboard-update",e=>{this.handleServerUpdate(e.detail)}),await this.syncExistingScoresToServer()}catch(e){console.warn("⚠️ Could not connect to JSONIC server, using local storage only:",e),this.serverClient=null}console.log("📊 Loading initial mini leaderboard..."),await this.loadMiniLeaderboard(),this.isInitialized=!0,console.log("✅ Highscore system initialization complete")}catch(e){console.error("❌ Failed to initialize JSONIC database:",e),console.log("📦 Falling back to localStorage..."),this.useFallbackStorage(),console.log("📊 Loading mini leaderboard with fallback..."),await this.loadMiniLeaderboard(),this.isInitialized=!0,console.log("✅ Highscore system initialized with fallback storage")}}}generatePlayerId(){return"player_"+Math.random().toString(36).substr(2,9)+Date.now().toString(36)}async submitScore(e){this.isInitialized||await this.initialize();const t={isHighscore:!1,rank:null,personalBest:null,globalRank:null};try{if(!this.db)return this.submitScoreFallback(e);const s=await this.getPersonalBest(e.gameMode);if(t.personalBest=(s==null?void 0:s.score)||0,!s||e.score>s.score){const r={playerId:this.playerId,playerName:e.playerName||"Anonymous",score:e.score,level:e.level,lines:e.lines,gameMode:e.gameMode,timestamp:Date.now(),metadata:e.metadata||{}};if(await this.db.insertScore(r),this.serverClient)try{await this.serverClient.submitScore(r),console.log("🌐 Score synced to global leaderboard");const i=await this.serverClient.getLeaderboard(e.gameMode,1e3);t.globalRank=i.findIndex(a=>a.score<e.score)+1,t.globalRank===0&&(t.globalRank=i.length+1)}catch(i){console.warn("⚠️ Could not sync score to server:",i)}t.rank=await this.getRank(e.score,e.gameMode),t.isHighscore=!0,this.leaderboardCache.clear(),await this.loadMiniLeaderboard(),this.notifySubscribers(),console.log(`🏆 New highscore saved: ${e.score} (Local Rank #${t.rank}, Global Rank #${t.globalRank||"N/A"})`)}}catch(s){return console.error("Failed to submit score to JSONIC:",s),this.submitScoreFallback(e)}return t}async getPersonalBest(e){if(!this.db)return this.getPersonalBestFallback(e);try{return(await this.db.findScores({playerId:this.playerId,gameMode:e},{sort:{score:-1},limit:1}))[0]||null}catch(t){return console.error("Failed to get personal best:",t),this.getPersonalBestFallback(e)}}async getRank(e,t){if(!this.db)return this.getLocalScores().filter(i=>i.gameMode===t&&i.score>e).length+1;try{return await this.db.countScores({gameMode:t,score:{$gt:e}})+1}catch(s){return console.error("Failed to get rank:",s),999}}async getLeaderboard(e="normal",t="all",s=100,r="global"){console.log("🎯 getLeaderboard() called:",{gameMode:e,timeRange:t,limit:s,source:r});const i=`${r}-${e}-${t}-${s}`;if(this.leaderboardCache.has(i)){const o=this.leaderboardCache.get(i);if(Date.now()-o.timestamp<3e4)return console.log("📦 Returning cached leaderboard data"),o.data}let a=[];if(console.log("📡 Server client:",this.serverClient?"exists":"null"),console.log("📡 Requesting source:",r),r==="global"&&this.serverClient)try{console.log("📡 Fetching from JSONIC server...");const o=await this.serverClient.getLeaderboard(e,{limit:s,timeRange:t});console.log("📊 Server returned",o.length,"scores"),console.log("📊 Raw server response:",JSON.stringify(o,null,2)),a=o.map((l,d)=>({rank:d+1,playerId:l.playerId,playerName:l.playerName,score:l.score,level:l.level,lines:l.lines,timestamp:l.timestamp,isCurrentPlayer:l.playerId===this.playerId,source:"global"})),console.log(`🌐 Loaded ${a.length} scores from global leaderboard`)}catch(o){console.warn("⚠️ Could not load global leaderboard:",o),r="local"}if(r==="local"||a.length===0){if(!this.db)return this.getLeaderboardFallback(e,t,s);try{const o={gameMode:e};t!=="all"&&(o.timestamp={$gte:this.getTimeCutoff(t)}),a=(await this.db.findScores(o,{sort:{score:-1},limit:s})).map((d,g)=>({rank:g+1,playerId:d.playerId,playerName:d.playerName,score:d.score,level:d.level,lines:d.lines,timestamp:d.timestamp,isCurrentPlayer:d.playerId===this.playerId,source:"local"})),console.log(`📱 Loaded ${a.length} scores from local leaderboard`)}catch(o){return console.error("Failed to get leaderboard from JSONIC:",o),this.getLeaderboardFallback(e,t,s)}}return this.leaderboardCache.set(i,{data:a,timestamp:Date.now()}),a}getTimeCutoff(e){const t=Date.now();switch(e){case"daily":return t-24*60*60*1e3;case"weekly":return t-7*24*60*60*1e3;case"monthly":return t-30*24*60*60*1e3;default:return 0}}async loadMiniLeaderboard(){console.log("🔄 loadMiniLeaderboard() called"),console.log("📱 DOM ready state:",document.readyState),console.log("📱 miniLeaderboard element exists:",!!document.getElementById("miniLeaderboard"));try{console.log("📡 Attempting to fetch global leaderboard...");const e=await this.getLeaderboard("normal","all",5,"global");console.log("📊 Global scores received:",e.length,"entries"),console.log("📊 Score data:",JSON.stringify(e,null,2)),this.updateMiniLeaderboard(e)}catch(e){console.error("❌ Failed to load mini leaderboard:",e.message);try{console.log("📁 Trying local leaderboard fallback...");const t=await this.getLeaderboard("normal","all",5,"local");console.log("📊 Local scores received:",t.length,"entries"),console.log("📊 Local data:",JSON.stringify(t,null,2)),this.updateMiniLeaderboard(t)}catch(t){console.error("❌ Failed to load local mini leaderboard:",t.message),console.log("📊 Displaying empty leaderboard"),this.updateMiniLeaderboard([])}}}updateMiniLeaderboard(e){console.log("🖥️ updateMiniLeaderboard() called with",(e==null?void 0:e.length)||0,"scores");const t=()=>{const s=document.getElementById("miniLeaderboard");if(!s){console.error("❌ miniLeaderboard container not found. Element may be missing from HTML or not yet rendered.");return}if(console.log("✅ Container found. Rendering scores."),!e||e.length===0){s.innerHTML='<div class="no-scores">No scores yet</div>';return}const r=e.map(i=>`
                <div class="mini-score-entry ${i.isCurrentPlayer?"current-player":""}">
                    <span class="rank">#${i.rank}</span>
                    <span class="name">${this.truncateName(i.playerName,10)}</span>
                    <span class="score">${i.score.toLocaleString()}</span>
                </div>
            `).join("");s.innerHTML=r,console.log("✅ Leaderboard updated.")};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}async displayLeaderboard(){document.getElementById("leaderboardContent")&&(this.setupLeaderboardTabs(),await this.loadLeaderboardContent("normal","all"))}setupLeaderboardTabs(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",async t=>{var i;document.querySelectorAll(".tab-btn").forEach(a=>a.classList.remove("active")),t.target.classList.add("active");const s=t.target.dataset.range,r=((i=document.querySelector(".mode-btn.active"))==null?void 0:i.dataset.mode)||"normal";await this.loadLeaderboardContent(r,s)})}),document.querySelectorAll(".mode-btn").forEach(e=>{e.addEventListener("click",async t=>{var i;document.querySelectorAll(".mode-btn").forEach(a=>a.classList.remove("active")),t.target.classList.add("active");const s=t.target.dataset.mode,r=((i=document.querySelector(".tab-btn.active"))==null?void 0:i.dataset.range)||"all";await this.loadLeaderboardContent(s,r)})})}async loadLeaderboardContent(e,t){var a;const s=document.getElementById("leaderboardContent");if(!s)return;s.innerHTML='<div class="loading">Loading scores...</div>';const i=((a=document.querySelector(".source-btn.active"))==null?void 0:a.dataset.source)==="global"?"global":"local";try{const o=await this.getLeaderboard(e,t,50,i);if(o.length===0){s.innerHTML=`<div class="no-scores">No ${i} scores recorded yet. Be the first!</div>`;return}const l=i==="global"?"🌐 Global":"📱 Local";s.innerHTML=`
                <div class="leaderboard-source">${l} Leaderboard</div>
                <div class="leaderboard-table">
                    <div class="leaderboard-header">
                        <span class="col-rank">RANK</span>
                        <span class="col-name">PLAYER</span>
                        <span class="col-score">SCORE</span>
                        <span class="col-level">LEVEL</span>
                        <span class="col-lines">LINES</span>
                        <span class="col-date">DATE</span>
                    </div>
                    <div class="leaderboard-entries">
                        ${o.map(d=>this.renderLeaderboardEntry(d)).join("")}
                    </div>
                </div>
            `}catch(o){console.error("Failed to load leaderboard content:",o),s.innerHTML='<div class="no-scores">Failed to load leaderboard. Please try again.</div>'}}renderLeaderboardEntry(e){const t=new Date(e.timestamp),s=t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:t.getFullYear()!==new Date().getFullYear()?"numeric":void 0});return`
            <div class="leaderboard-entry ${e.isCurrentPlayer?"current-player":""}">
                <span class="col-rank">
                    ${e.rank<=3?this.getRankMedal(e.rank):""}
                    #${e.rank}
                </span>
                <span class="col-name">${this.truncateName(e.playerName,15)}</span>
                <span class="col-score">${e.score.toLocaleString()}</span>
                <span class="col-level">${e.level}</span>
                <span class="col-lines">${e.lines}</span>
                <span class="col-date">${s}</span>
            </div>
        `}getRankMedal(e){switch(e){case 1:return"🥇";case 2:return"🥈";case 3:return"🥉";default:return""}}truncateName(e,t){return e.length<=t?e:e.substr(0,t-3)+"..."}subscribe(e){return this.updateCallbacks.add(e),()=>this.updateCallbacks.delete(e)}notifySubscribers(){this.updateCallbacks.forEach(e=>e())}async getStats(){if(!this.db){const e=this.getLocalScores();return{totalScores:e.length,uniquePlayers:new Set(e.map(t=>t.playerId)).size,highestScore:Math.max(...e.map(t=>t.score),0)}}try{return await this.db.getStats()}catch(e){return console.error("Failed to get stats:",e),{totalScores:0,uniquePlayers:0,highestScore:0}}}useFallbackStorage(){console.log("📦 Using localStorage fallback for highscores"),this.db=null}submitScoreFallback(e){var r;const t=this.getLocalScores();t.push({...e,playerId:this.playerId,timestamp:Date.now()}),t.sort((i,a)=>a.score-i.score),t.splice(100),localStorage.setItem("jetrix_scores",JSON.stringify(t));const s=t.findIndex(i=>i.playerId===this.playerId&&i.score===e.score)+1;return{isHighscore:s<=100,rank:s,personalBest:((r=this.getPersonalBestFallback(e.gameMode))==null?void 0:r.score)||0}}getPersonalBestFallback(e){const s=this.getLocalScores().filter(r=>r.playerId===this.playerId&&r.gameMode===e);return s.length===0?null:s.reduce((r,i)=>i.score>r.score?i:r)}getLeaderboardFallback(e,t,s){const r=this.getLocalScores(),i=this.getTimeCutoff(t);return r.filter(o=>o.gameMode===e&&o.timestamp>=i).slice(0,s).map((o,l)=>({rank:l+1,playerId:o.playerId,playerName:o.playerName||"Anonymous",score:o.score,level:o.level||1,lines:o.lines||0,timestamp:o.timestamp,isCurrentPlayer:o.playerId===this.playerId}))}getLocalScores(){try{const e=localStorage.getItem("jetrix_scores");return e?JSON.parse(e):[]}catch{return[]}}handleServerUpdate(e){this.leaderboardCache.clear(),e.score&&e.gameMode==="normal"&&this.loadMiniLeaderboard(),this.notifySubscribers(),console.log("📡 Received leaderboard update from server:",e)}async syncWithServer(){if(this.serverClient)try{const e=await this.db.getAllScores();for(const t of e)try{await this.serverClient.submitScore(t)}catch(s){console.warn("Failed to sync score:",t,s)}console.log(`✅ Synced ${e.length} local scores to server`)}catch(e){console.error("Failed to sync with server:",e)}}async syncExistingScoresToServer(){if(this.serverClient)try{console.log("🔄 Checking for existing local scores to sync...");let e=[];this.db&&(e=await this.db.getAllScores(),console.log(`📱 Found ${e.length} scores in local JSONIC database`));const t=this.getLocalScores();console.log(`💾 Found ${t.length} legacy scores in localStorage`);const s=[...e];for(const a of t)if(!s.some(l=>l.playerId===a.playerId&&l.score===a.score&&l.timestamp===a.timestamp)){const l={playerId:a.playerId||this.playerId,playerName:a.playerName||"Anonymous",score:a.score,level:a.level||1,lines:a.lines||0,gameMode:a.gameMode||"normal",timestamp:a.timestamp||Date.now(),metadata:a.metadata||{}};s.push(l),this.db&&await this.db.insertScore(l)}if(console.log(`🎯 Total unique scores to sync: ${s.length}`),s.length===0){console.log("✅ No existing scores to sync");return}let r=0,i=0;for(const a of s)try{await this.serverClient.submitScore(a),r++,console.log(`✅ Synced score: ${a.score} by ${a.playerName}`)}catch(o){i++,console.warn(`⚠️ Failed to sync score ${a.score}:`,o.message)}console.log(`🌐 Sync complete: ${r} uploaded, ${i} skipped`),this.leaderboardCache.clear()}catch(e){console.error("❌ Failed to sync existing scores:",e)}}disconnect(){this.serverClient&&(this.serverClient.disconnect(),this.serverClient=null)}}const M={I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:"#00ffff"},O:{shape:[[1,1],[1,1]],color:"#ffff00"},T:{shape:[[0,1,0],[1,1,1],[0,0,0]],color:"#ff00ff"},S:{shape:[[0,1,1],[1,1,0],[0,0,0]],color:"#00ff00"},Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],color:"#ff0000"},J:{shape:[[1,0,0],[1,1,1],[0,0,0]],color:"#0000ff"},L:{shape:[[0,0,1],[1,1,1],[0,0,0]],color:"#ff8800"}},f={BOARD_WIDTH:10,BOARD_HEIGHT:20,LOCK_DELAY:500,POINTS:{SINGLE:100,DOUBLE:300,TRIPLE:500,TETRIS:800,SOFT_DROP:1,HARD_DROP:2,COMBO_MULTIPLIER:50},DIFFICULTY:{easy:{speed:1e3,levelSpeed:80},normal:{speed:800,levelSpeed:60},hard:{speed:600,levelSpeed:40},extreme:{speed:400,levelSpeed:20}}};class ne{constructor(){this.board=[],this.currentPiece=null,this.nextPieces=[],this.holdPiece=null,this.canHold=!0,this.score=0,this.level=1,this.lines=0,this.combo=0,this.gameMode="normal",this.isPlaying=!1,this.isPaused=!1,this.isGameOver=!1,this.dropTimer=0,this.lockTimer=0,this.bag=[],this.renderer=null,this.controls=null,this.highscores=null,this.playerName="Player",this.stats={piecesPlaced:0,tSpins:0,maxCombo:0,startTime:0,endTime:0}}async initialize(){this.resetBoard(),this.renderer=new z(this),this.renderer.initialize(),this.controls=new U(this),this.controls.initialize(),this.highscores=new j,await this.highscores.initialize(),this.setupUI(),this.showStartModal()}resetBoard(){this.board=Array(f.BOARD_HEIGHT).fill(null).map(()=>Array(f.BOARD_WIDTH).fill(0))}setupUI(){var r,i,a,o,l;const e=document.getElementById("startGame");e==null||e.addEventListener("click",()=>this.startGame()),document.querySelectorAll(".btn-difficulty").forEach(d=>{d.addEventListener("click",g=>{document.querySelectorAll(".btn-difficulty").forEach(I=>I.classList.remove("active")),g.target.classList.add("active"),this.gameMode=g.target.dataset.mode})});const t=document.getElementById("playerName");t==null||t.addEventListener("change",d=>{this.playerName=d.target.value||"Player",localStorage.setItem("playerName",this.playerName)});const s=localStorage.getItem("playerName");s&&t&&(t.value=s,this.playerName=s),(r=document.getElementById("viewHighscores"))==null||r.addEventListener("click",()=>{this.showHighscoresModal()}),(i=document.getElementById("closeHighscores"))==null||i.addEventListener("click",()=>{document.getElementById("highscoreModal").style.display="none"}),(a=document.getElementById("playAgain"))==null||a.addEventListener("click",()=>{this.hideGameOverModal(),this.startGame()}),(o=document.getElementById("mainMenu"))==null||o.addEventListener("click",()=>{this.hideGameOverModal(),this.showStartModal()}),(l=document.getElementById("overlayButton"))==null||l.addEventListener("click",()=>{this.isPaused&&this.resume()})}showStartModal(){document.getElementById("startModal").style.display="flex",document.getElementById("gameOverModal").style.display="none",document.getElementById("highscoreModal").style.display="none"}hideStartModal(){document.getElementById("startModal").style.display="none"}showHighscoresModal(){document.getElementById("highscoreModal").style.display="flex",this.highscores.displayLeaderboard()}showGameOverModal(){const e=document.getElementById("gameOverModal");document.getElementById("finalScore").textContent=this.score.toLocaleString(),document.getElementById("finalLevel").textContent=this.level,document.getElementById("finalLines").textContent=this.lines,e.style.display="flex"}hideGameOverModal(){document.getElementById("gameOverModal").style.display="none"}async startGame(){this.resetBoard(),this.score=0,this.level=1,this.lines=0,this.combo=0,this.isPlaying=!0,this.isPaused=!1,this.isGameOver=!1,this.holdPiece=null,this.canHold=!0,this.bag=[],this.nextPieces=[],this.stats={piecesPlaced:0,tSpins:0,maxCombo:0,startTime:Date.now(),endTime:0},this.hideStartModal(),this.hideGameOverModal(),this.updateDisplay();for(let e=0;e<3;e++)this.nextPieces.push(this.getNextFromBag());this.spawnPiece(),this.gameLoop()}gameLoop(e=0){if(!(!this.isPlaying||this.isGameOver)){if(!this.isPaused){const t=this.getDropSpeed();this.dropTimer+=16.67,this.dropTimer>=t&&(this.dropTimer=0,this.moveDown()?this.lockTimer=0:(this.lockTimer+=t,this.lockTimer>=f.LOCK_DELAY&&this.lockPiece()))}this.renderer.render(),requestAnimationFrame(t=>this.gameLoop(t))}}getDropSpeed(){const e=f.DIFFICULTY[this.gameMode],t=e.speed,s=e.levelSpeed*(this.level-1);return Math.max(50,t-s)}getNextFromBag(){if(this.bag.length===0){this.bag=["I","O","T","S","Z","J","L"];for(let e=this.bag.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this.bag[e],this.bag[t]]=[this.bag[t],this.bag[e]]}}return this.bag.pop()}spawnPiece(){const e=this.nextPieces.shift();this.nextPieces.push(this.getNextFromBag());const t=M[e].shape,s=M[e].color;this.currentPiece={type:e,shape:t,color:s,x:Math.floor((f.BOARD_WIDTH-t[0].length)/2),y:0,rotation:0},this.isValidPosition(this.currentPiece.x,this.currentPiece.y,t)||this.gameOver(),this.canHold=!0,this.dropTimer=0,this.lockTimer=0}isValidPosition(e,t,s){for(let r=0;r<s.length;r++)for(let i=0;i<s[r].length;i++)if(s[r][i]){const a=e+i,o=t+r;if(a<0||a>=f.BOARD_WIDTH||o>=f.BOARD_HEIGHT||o>=0&&this.board[o][a])return!1}return!0}moveLeft(){return!this.currentPiece||this.isPaused?!1:this.isValidPosition(this.currentPiece.x-1,this.currentPiece.y,this.currentPiece.shape)?(this.currentPiece.x--,this.lockTimer=0,!0):!1}moveRight(){return!this.currentPiece||this.isPaused?!1:this.isValidPosition(this.currentPiece.x+1,this.currentPiece.y,this.currentPiece.shape)?(this.currentPiece.x++,this.lockTimer=0,!0):!1}moveDown(){return!this.currentPiece||this.isPaused?!1:this.isValidPosition(this.currentPiece.x,this.currentPiece.y+1,this.currentPiece.shape)?(this.currentPiece.y++,this.score+=f.POINTS.SOFT_DROP,!0):!1}hardDrop(){if(!this.currentPiece||this.isPaused)return;let e=0;for(;this.isValidPosition(this.currentPiece.x,this.currentPiece.y+1,this.currentPiece.shape);)this.currentPiece.y++,e++;this.score+=e*f.POINTS.HARD_DROP,this.lockPiece(),this.playSound("drop")}rotate(e=!0){if(!this.currentPiece||this.isPaused)return!1;const t=this.rotateMatrix(this.currentPiece.shape,e);if(this.isValidPosition(this.currentPiece.x,this.currentPiece.y,t))return this.currentPiece.shape=t,this.currentPiece.rotation=(this.currentPiece.rotation+(e?1:3))%4,this.lockTimer=0,this.checkTSpin(),!0;const s=this.getWallKicks(this.currentPiece.type,this.currentPiece.rotation,e);for(const[r,i]of s)if(this.isValidPosition(this.currentPiece.x+r,this.currentPiece.y+i,t))return this.currentPiece.x+=r,this.currentPiece.y+=i,this.currentPiece.shape=t,this.currentPiece.rotation=(this.currentPiece.rotation+(e?1:3))%4,this.lockTimer=0,this.checkTSpin(),!0;return!1}rotateMatrix(e,t=!0){const s=e.length,r=Array(s).fill(null).map(()=>Array(s).fill(0));for(let i=0;i<s;i++)for(let a=0;a<s;a++)t?r[a][s-1-i]=e[i][a]:r[s-1-a][i]=e[i][a];return r}getWallKicks(e,t,s){return e==="I"?[[-1,0],[2,0],[-1,2],[2,-1]]:e==="O"?[]:[[-1,0],[1,0],[-1,-1],[1,-1],[0,1]]}checkTSpin(){if(this.currentPiece.type!=="T")return!1;const e=[[this.currentPiece.x-1,this.currentPiece.y-1],[this.currentPiece.x+1,this.currentPiece.y-1],[this.currentPiece.x-1,this.currentPiece.y+1],[this.currentPiece.x+1,this.currentPiece.y+1]];let t=0;for(const[s,r]of e)(s<0||s>=f.BOARD_WIDTH||r>=f.BOARD_HEIGHT||r>=0&&this.board[r][s])&&t++;return t>=3?(this.stats.tSpins++,!0):!1}hold(){if(!this.currentPiece||!this.canHold||this.isPaused)return;const e=this.currentPiece.type;if(this.holdPiece){const t=this.holdPiece;this.holdPiece=e;const s=M[t].shape,r=M[t].color;this.currentPiece={type:t,shape:s,color:r,x:Math.floor((f.BOARD_WIDTH-s[0].length)/2),y:0,rotation:0}}else this.holdPiece=e,this.spawnPiece();this.canHold=!1,this.renderer.renderHold()}lockPiece(){if(!this.currentPiece)return;const e=this.currentPiece.shape;for(let s=0;s<e.length;s++)for(let r=0;r<e[s].length;r++)if(e[s][r]){const i=this.currentPiece.y+s,a=this.currentPiece.x+r;i>=0&&(this.board[i][a]=this.currentPiece.color)}this.stats.piecesPlaced++;const t=this.clearLines();t>0?(this.updateScore(t),this.combo++,this.stats.maxCombo=Math.max(this.stats.maxCombo,this.combo)):this.combo=0,this.spawnPiece()}clearLines(){let e=0;for(let t=f.BOARD_HEIGHT-1;t>=0;t--)this.board[t].every(s=>s!==0)&&(this.board.splice(t,1),this.board.unshift(Array(f.BOARD_WIDTH).fill(0)),e++,t++);if(e>0){this.lines+=e;const t=Math.floor(this.lines/10)+1;t>this.level&&(this.level=t,this.playSound("levelUp")),e===4?this.playSound("tetris"):this.playSound("clear"),this.renderer.animateLineClear(e)}return e}updateScore(e){let t=0;switch(e){case 1:t=f.POINTS.SINGLE;break;case 2:t=f.POINTS.DOUBLE;break;case 3:t=f.POINTS.TRIPLE;break;case 4:t=f.POINTS.TETRIS;break}t*=this.level,this.combo>0&&(t+=f.POINTS.COMBO_MULTIPLIER*this.combo),this.score+=t,this.updateDisplay()}updateDisplay(){document.getElementById("score").textContent=this.score.toLocaleString(),document.getElementById("level").textContent=this.level,document.getElementById("lines").textContent=this.lines}pause(){if(!this.isPlaying||this.isGameOver)return;this.isPaused=!0;const e=document.getElementById("gameOverlay");e.style.display="flex",document.getElementById("overlayTitle").textContent="PAUSED",document.getElementById("overlayMessage").textContent="Press SPACE or ESC to continue"}resume(){this.isPaused=!1,document.getElementById("gameOverlay").style.display="none"}async gameOver(){this.isGameOver=!0,this.isPlaying=!1,this.stats.endTime=Date.now(),this.playSound("gameOver");const e=await this.highscores.submitScore({playerName:this.playerName,score:this.score,level:this.level,lines:this.lines,gameMode:this.gameMode,metadata:{piecesPlaced:this.stats.piecesPlaced,tSpins:this.stats.tSpins,maxCombo:this.stats.maxCombo,timeElapsed:this.stats.endTime-this.stats.startTime}});if(e.isHighscore){const t=document.getElementById("highscoreRank"),s=document.getElementById("rankNumber");t.style.display="flex",s.textContent=e.rank}else document.getElementById("highscoreRank").style.display="none";setTimeout(()=>this.showGameOverModal(),1e3)}playSound(e){}getGhostPosition(){if(!this.currentPiece)return null;let e=this.currentPiece.y;for(;this.isValidPosition(this.currentPiece.x,e+1,this.currentPiece.shape);)e++;return{x:this.currentPiece.x,y:e,shape:this.currentPiece.shape,color:this.currentPiece.color}}}window.addEventListener("DOMContentLoaded",async()=>{const n=new ne,e=new j;await n.initialize(),await e.initialize(),window.game=n,window.highscores=e});
